"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[2266],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>p});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function i(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=a.createContext({}),c=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):i(i({},t),e)),n},u=function(e){var t=c(e.components);return a.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},d=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),d=c(n),p=r,m=d["".concat(l,".").concat(p)]||d[p]||h[p]||o;return n?a.createElement(m,i(i({ref:t},u),{},{components:n})):a.createElement(m,i({ref:t},u))}));function p(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=n[c];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},8998:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var a=n(7462),r=(n(7294),n(3905));const o={},i=void 0,s={unversionedId:"Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify",id:"Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify",title:"Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify",description:"Chapter 11. Concurrency\uff08\u5e76\u53d1\uff09",source:"@site/docs/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify.md",sourceDirName:"Books/EffectiveJava3/Chapter-11",slug:"/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify",permalink:"/docs/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-81-Prefer-concurrency-utilities-to-wait-and-notify.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Chapter-11-Item-80-Prefer-executors,-tasks,-and-streams-to-threads",permalink:"/docs/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-80-Prefer-executors,-tasks,-and-streams-to-threads"},next:{title:"Chapter-11-Item-82-Document-thread-safety",permalink:"/docs/Books/EffectiveJava3/Chapter-11/Chapter-11-Item-82-Document-thread-safety"}},l={},c=[{value:"Chapter 11. Concurrency\uff08\u5e76\u53d1\uff09",id:"chapter-11-concurrency\u5e76\u53d1",level:2},{value:"Item 81: Prefer concurrency utilities to wait and notify\uff08\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u4f18\u4e8e wait \u548c notify\uff09",id:"item-81-prefer-concurrency-utilities-to-wait-and-notify\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u4f18\u4e8e-wait-\u548c-notify",level:3}],u={toc:c};function h(e){let{components:t,...n}=e;return(0,r.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"chapter-11-concurrency\u5e76\u53d1"},"Chapter 11. Concurrency\uff08\u5e76\u53d1\uff09"),(0,r.kt)("h3",{id:"item-81-prefer-concurrency-utilities-to-wait-and-notify\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u4f18\u4e8e-wait-\u548c-notify"},"Item 81: Prefer concurrency utilities to wait and notify\uff08\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u4f18\u4e8e wait \u548c notify\uff09"),(0,r.kt)("p",null,"The first edition of this book devoted an item to the correct use of wait and notify ","[Bloch01, Item 50]",". Its advice is still valid and is summarized at end of this item, but this advice is far less important than it once was. This is because there is far less reason to use wait and notify. Since Java 5, the platform has provided higher-level concurrency utilities that do the sorts of things you formerly had to hand-code atop wait and notify. ",(0,r.kt)("strong",{parentName:"p"},"Given the difficulty of using wait and notify correctly, you should use the higher-level concurrency utilities instead.")),(0,r.kt)("p",null,"\u8fd9\u672c\u4e66\u7684\u7b2c\u4e00\u7248\u4e13\u95e8\u4ecb\u7ecd\u4e86 wait \u548c notify \u7684\u6b63\u786e\u7528\u6cd5 ","[Bloch01, item 50]","\u3002\u8fd9\u4e9b\u5efa\u8bae\u4ecd\u7136\u6709\u6548\uff0c\u5e76\u5728\u672c\u6761\u76ee\u672b\u5c3e\u4f5c\u4e86\u603b\u7ed3\uff0c\u4f46\u8fd9\u4e00\u5efa\u8bae\u5df2\u8fdc\u4e0d\u5982\u4ece\u524d\u91cd\u8981\u3002\u8fd9\u662f\u56e0\u4e3a\u4f7f\u7528 wait \u548c notify \u7684\u7406\u7531\u8981\u5c11\u5f97\u591a\u3002\u81ea Java 5 \u4ee5\u6765\uff0c\u8be5\u5e73\u53f0\u63d0\u4f9b\u4e86\u66f4\u9ad8\u7ea7\u522b\u7684\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\uff0c\u53ef\u4ee5\u6267\u884c\u4ee5\u524d\u5fc5\u987b\u5728 wait \u548c notify \u4e0a\u624b\u5de5\u7f16\u5199\u4ee3\u7801\u7684\u64cd\u4f5c\u3002",(0,r.kt)("strong",{parentName:"p"},"\u8003\u8651\u5230\u6b63\u786e\u4f7f\u7528 wait \u548c notify \u7684\u56f0\u96be\uff0c\u4f60\u5e94\u8be5\u4f7f\u7528\u66f4\u9ad8\u7ea7\u522b\u7684\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u3002")),(0,r.kt)("p",null,"The higher-level utilities in java.util.concurrent fall into three categories: the Executor Framework, which was covered briefly in Item 80; concurrent collections; and synchronizers. Concurrent collections and synchronizers are covered briefly in this item."),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"java.util.concurrent")," \u4e2d\u7ea7\u522b\u8f83\u9ad8\u7684\u5b9e\u7528\u5de5\u5177\u53ef\u5206\u4e3a\u4e09\u7c7b\uff1aExecutor \u6846\u67b6\uff0c",(0,r.kt)("a",{parentName:"p",href:"./Chapter-11/Chapter-11-Item-80-Prefer-executors,-tasks,-and-streams-to-threads"},"Item-80")," \u7b80\u8981\u4ecb\u7ecd\u4e86\u8be5\u6846\u67b6\uff1b\u5e76\u53d1\u96c6\u5408\uff1b\u540c\u6b65\u5668\u3002\u672c\u6761\u76ee\u7b80\u8981\u4ecb\u7ecd\u5e76\u53d1\u96c6\u5408\u548c\u540c\u6b65\u5668\u3002"),(0,r.kt)("p",null,"The concurrent collections are high-performance concurrent implementations of standard collection interfaces such as List, Queue, and Map. To provide high concurrency, these implementations manage their own synchronization internally (Item 79). Therefore, ",(0,r.kt)("strong",{parentName:"p"},"it is impossible to exclude concurrent activity from a concurrent collection; locking it will only slow the program.")),(0,r.kt)("p",null,"\u5e76\u53d1\u96c6\u5408\u662f\u6807\u51c6\u96c6\u5408\u63a5\u53e3\uff0c\u5982 List\u3001Queue \u548c Map \u7684\u9ad8\u6027\u80fd\u5e76\u53d1\u5b9e\u73b0\u3002\u4e3a\u4e86\u63d0\u4f9b\u9ad8\u5e76\u53d1\u6027\uff0c\u8fd9\u4e9b\u5b9e\u73b0\u5728\u5185\u90e8\u7ba1\u7406\u5b83\u4eec\u81ea\u5df1\u7684\u540c\u6b65\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-11/Chapter-11-Item-79-Avoid-excessive-synchronization"},"Item-79"),"\uff09\u3002\u56e0\u6b64\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u4e0d\u53ef\u80fd\u4ece\u5e76\u53d1\u96c6\u5408\u4e2d\u6392\u9664\u5e76\u53d1\u6d3b\u52a8\uff1b\u9501\u5b9a\u5b83\u53ea\u4f1a\u4f7f\u7a0b\u5e8f\u53d8\u6162\u3002")),(0,r.kt)("p",null,"Because you can\u2019t exclude concurrent activity on concurrent collections, you can\u2019t atomically compose method invocations on them either. Therefore, concurrent collection interfaces were outfitted with state-dependent modify operations, which combine several primitives into a single atomic operation. These operations proved sufficiently useful on concurrent collections that they were added to the corresponding collection interfaces in Java 8, using default methods (Item 21)."),(0,r.kt)("p",null,"\u56e0\u4e3a\u4e0d\u80fd\u6392\u9664\u5e76\u53d1\u96c6\u5408\u4e0a\u7684\u5e76\u53d1\u6d3b\u52a8\uff0c\u6240\u4ee5\u4e5f\u4e0d\u80fd\u539f\u5b50\u5730\u7ec4\u5408\u5bf9\u5b83\u4eec\u7684\u65b9\u6cd5\u8c03\u7528\u3002\u56e0\u6b64\uff0c\u5e76\u53d1\u96c6\u5408\u63a5\u53e3\u914d\u5907\u4e86\u4f9d\u8d56\u4e8e\u72b6\u6001\u7684\u4fee\u6539\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5c06\u591a\u4e2a\u57fa\u672c\u64cd\u4f5c\u7ec4\u5408\u6210\u5355\u4e2a\u539f\u5b50\u64cd\u4f5c\u3002\u8fd9\u4e9b\u64cd\u4f5c\u5728\u5e76\u53d1\u96c6\u5408\u4e0a\u975e\u5e38\u6709\u7528\uff0c\u56e0\u6b64\u4f7f\u7528\u9ed8\u8ba4\u65b9\u6cd5\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-4-Item-21-Design-interfaces-for-posterity"},"Item-21"),"\uff09\u5c06\u5b83\u4eec\u6dfb\u52a0\u5230 Java 8 \u4e2d\u76f8\u5e94\u7684\u96c6\u5408\u63a5\u53e3\u3002"),(0,r.kt)("p",null,"For example, Map\u2019s putIfAbsent(key, value) method inserts a mapping for a key if none was present and returns the previous value associated with the key, or null if there was none. This makes it easy to implement thread-safe canonicalizing maps. This method simulates the behavior of String.intern:"),(0,r.kt)("p",null,"\u4f8b\u5982\uff0cMap \u7684 ",(0,r.kt)("inlineCode",{parentName:"p"},"putIfAbsent(key, value)")," \u65b9\u6cd5\u4e3a\u4e00\u4e2a\u6ca1\u6709\u6620\u5c04\u7684\u952e\u63d2\u5165\u4e00\u4e2a\u6620\u5c04\uff0c\u5e76\u8fd4\u56de\u4e0e\u952e\u5173\u8054\u7684\u524d\u4e00\u4e2a\u503c\uff0c\u5982\u679c\u6ca1\u6709\uff0c\u5219\u8fd4\u56de null\u3002\u8fd9\u4f7f\u5f97\u5b9e\u73b0\u7ebf\u7a0b\u5b89\u5168\u7684\u89c4\u8303\u5316 Map \u53d8\u5f97\u5f88\u5bb9\u6613\u3002\u8fd9\u4e2a\u65b9\u6cd5\u6a21\u62df\u4e86 ",(0,r.kt)("inlineCode",{parentName:"p"},"String.intern")," \u7684\u884c\u4e3a\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Concurrent canonicalizing map atop ConcurrentMap - not optimal\nprivate static final ConcurrentMap<String, String> map =new ConcurrentHashMap<>();\npublic static String intern(String s) {\n    String previousValue = map.putIfAbsent(s, s);\n    return previousValue == null ? s : previousValue;\n}\n")),(0,r.kt)("p",null,"In fact, you can do even better. ConcurrentHashMap is optimized for retrieval operations, such as get. Therefore, it is worth invoking get initially and calling putIfAbsent only if get indicates that it is necessary:"),(0,r.kt)("p",null,"\u4e8b\u5b9e\u4e0a\uff0c\u4f60\u53ef\u4ee5\u505a\u5f97\u66f4\u597d\u3002ConcurrentHashMap \u9488\u5bf9 get \u7b49\u68c0\u7d22\u64cd\u4f5c\u8fdb\u884c\u4e86\u4f18\u5316\u3002\u56e0\u6b64\uff0c\u53ea\u6709\u5728 get \u8868\u660e\u6709\u5fc5\u8981\u65f6\uff0c\u624d\u503c\u5f97\u9996\u5148\u8c03\u7528 get \u518d\u8c03\u7528 putIfAbsent:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Concurrent canonicalizing map atop ConcurrentMap - faster!\npublic static String intern(String s) {\n    String result = map.get(s);\n    if (result == null) {\n        result = map.putIfAbsent(s, s);\n        if (result == null)\n        result = s;\n    }\n    return result;\n}\n")),(0,r.kt)("p",null,"Besides offering excellent concurrency, ConcurrentHashMap is very fast. On my machine, the intern method above is over six times faster than String.intern (but keep in mind that String.intern must employ some strategy to keep from leaking memory in a long-lived application). Concurrent collections make synchronized collections largely obsolete. For example, ",(0,r.kt)("strong",{parentName:"p"},"use ConcurrentHashMap in preference to Collections.synchronizedMap.")," Simply replacing synchronized maps with concurrent maps can dramatically increase the performance of concurrent applications."),(0,r.kt)("p",null,"\u9664\u4e86\u63d0\u4f9b\u4f18\u79c0\u7684\u5e76\u53d1\u6027\uff0cConcurrentHashMap \u8fd8\u975e\u5e38\u5feb\u3002\u5728\u6211\u7684\u673a\u5668\u4e0a\uff0c\u4e0a\u9762\u7684 intern \u65b9\u6cd5\u6bd4 ",(0,r.kt)("inlineCode",{parentName:"p"},"String.intern")," \u5feb\u516d\u500d\u591a\uff08\u4f46\u662f\u8bf7\u8bb0\u4f4f\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"String.intern")," \u5fc5\u987b\u4f7f\u7528\u4e00\u4e9b\u7b56\u7565\u6765\u9632\u6b62\u5728\u957f\u65f6\u95f4\u8fd0\u884c\u7684\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5185\u5b58\u6cc4\u6f0f\uff09\u3002\u5e76\u53d1\u96c6\u5408\u4f7f\u540c\u6b65\u96c6\u5408\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u8fc7\u65f6\u3002\u4f8b\u5982\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u4f7f\u7528 ConcurrentHashMap \u800c\u4e0d\u662f ",(0,r.kt)("inlineCode",{parentName:"strong"},"Collections.synchronizedMap"),"\u3002")," \u53ea\u8981\u7528\u5e76\u53d1 Map \u66ff\u6362\u540c\u6b65 Map \u5c31\u53ef\u4ee5\u663e\u8457\u63d0\u9ad8\u5e76\u53d1\u5e94\u7528\u7a0b\u5e8f\u7684\u6027\u80fd\u3002"),(0,r.kt)("p",null,"Some of the collection interfaces were extended with blocking operations, which wait (or block) until they can be successfully performed. For example, BlockingQueue extends Queue and adds several methods, including take, which removes and returns the head element from the queue, waiting if the queue is empty. This allows blocking queues to be used for work queues (also known as producer-consumer queues), to which one or more producer threads enqueue work items and from which one or more consumer threads dequeue and process items as they become available. As you\u2019d expect, most ExecutorService implementations, including ThreadPoolExecutor, use a BlockingQueue (Item 80)."),(0,r.kt)("p",null,"\u4e00\u4e9b\u96c6\u5408\u63a5\u53e3\u4f7f\u7528\u963b\u585e\u64cd\u4f5c\u8fdb\u884c\u4e86\u6269\u5c55\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5c06\u7b49\u5f85\uff08\u6216\u963b\u585e\uff09\u6210\u529f\u6267\u884c\u3002\u4f8b\u5982\uff0cBlockingQueue \u6269\u5c55\u4e86 Queue \u5e76\u6dfb\u52a0\u4e86\u51e0\u4e2a\u65b9\u6cd5\uff0c\u5305\u62ec take\uff0c\u5b83\u4ece\u961f\u5217\u4e2d\u5220\u9664\u5e76\u8fd4\u56de\u9996\u4e2a\u5143\u7d20\uff0c\u5982\u679c\u961f\u5217\u4e3a\u7a7a\uff0c\u5219\u7b49\u5f85\u3002\u8fd9\u5141\u8bb8\u5c06\u963b\u585e\u961f\u5217\u7528\u4e8e\u5de5\u4f5c\u961f\u5217\uff08\u4e5f\u79f0\u4e3a\u751f\u4ea7\u8005-\u6d88\u8d39\u8005\u961f\u5217\uff09\uff0c\u4e00\u4e2a\u6216\u591a\u4e2a\u751f\u4ea7\u8005\u7ebf\u7a0b\u5c06\u5de5\u4f5c\u9879\u6dfb\u52a0\u5230\u8be5\u5de5\u4f5c\u961f\u5217\u4e2d\uff0c\u4e00\u4e2a\u6216\u591a\u4e2a\u6d88\u8d39\u8005\u7ebf\u7a0b\u5c06\u5de5\u4f5c\u9879\u4ece\u8be5\u5de5\u4f5c\u961f\u5217\u4e2d\u53d6\u51fa\u5e76\u5728\u8fd9\u4e9b\u5de5\u4f5c\u9879\u53ef\u7528\u65f6\u5904\u7406\u5b83\u4eec\u3002\u6b63\u5982\u4f60\u6240\u671f\u671b\u7684\uff0c\u5927\u591a\u6570 ExecutorService \u5b9e\u73b0\uff0c\u5305\u62ec ThreadPoolExecutor\uff0c\u90fd\u4f7f\u7528 BlockingQueue\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-11/Chapter-11-Item-80-Prefer-executors,-tasks,-and-streams-to-threads"},"Item-80"),"\uff09\u3002"),(0,r.kt)("p",null,"Synchronizers are objects that enable threads to wait for one another, allowing them to coordinate their activities. The most commonly used synchronizers are CountDownLatch and Semaphore. Less commonly used are CyclicBarrier and Exchanger. The most powerful synchronizer is Phaser."),(0,r.kt)("p",null,"\u540c\u6b65\u5668\u662f\u5141\u8bb8\u7ebf\u7a0b\u5f7c\u6b64\u7b49\u5f85\u7684\u5bf9\u8c61\uff0c\u5141\u8bb8\u5b83\u4eec\u534f\u8c03\u5404\u81ea\u7684\u6d3b\u52a8\u3002\u6700\u5e38\u7528\u7684\u540c\u6b65\u5668\u662f CountDownLatch \u548c Semaphore\u3002\u8f83\u4e0d\u5e38\u7528\u7684\u662f CyclicBarrier \u548c Exchanger\u3002\u6700\u5f3a\u5927\u7684\u540c\u6b65\u5668\u662f Phaser\u3002"),(0,r.kt)("p",null,"Countdown latches are single-use barriers that allow one or more threads to wait for one or more other threads to do something. The sole constructor for CountDownLatch takes an int that is the number of times the countDown method must be invoked on the latch before all waiting threads are allowed to proceed."),(0,r.kt)("p",null,"Countdown latches are single-use barriers\uff0c\u5141\u8bb8\u4e00\u4e2a\u6216\u591a\u4e2a\u7ebf\u7a0b\u7b49\u5f85\u4e00\u4e2a\u6216\u591a\u4e2a\u5176\u4ed6\u7ebf\u7a0b\u6267\u884c\u67d0\u4e9b\u64cd\u4f5c\u3002CountDownLatch \u7684\u60df\u4e00\u6784\u9020\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a int\uff0c\u8fd9\u4e2a int \u662f\u5728\u5141\u8bb8\u6240\u6709\u7b49\u5f85\u7684\u7ebf\u7a0b\u7ee7\u7eed\u4e4b\u524d\uff0c\u5fc5\u987b\u5728\u9501\u5b58\u5668\u4e0a\u8c03\u7528\u5012\u8ba1\u65f6\u65b9\u6cd5\u7684\u6b21\u6570\u3002"),(0,r.kt)("p",null,"It is surprisingly easy to build useful things atop this simple primitive. For example, suppose you want to build a simple framework for timing the concurrent execution of an action. This framework consists of a single method that takes an executor to execute the action, a concurrency level representing the number of actions to be executed concurrently, and a runnable representing the action. All of the worker threads ready themselves to run the action before the timer thread starts the clock. When the last worker thread is ready to run the action, the timer thread \u201cfires the starting gun,\u201d allowing the worker threads to perform the action. As soon as the last worker thread finishes performing the action, the timer thread stops the clock. Implementing this logic directly on top of wait and notify would be messy to say the least, but it is surprisingly straightforward on top of CountDownLatch:"),(0,r.kt)("p",null,"\u5728\u8fd9\u4e2a\u7b80\u5355\u7684\u57fa\u672c\u7c7b\u578b\u4e0a\u6784\u5efa\u6709\u7528\u7684\u4e1c\u897f\u975e\u5e38\u5bb9\u6613\u3002\u4f8b\u5982\uff0c\u5047\u8bbe\u4f60\u60f3\u8981\u6784\u5efa\u4e00\u4e2a\u7b80\u5355\u7684\u6846\u67b6\u6765\u4e3a\u4e00\u4e2a\u64cd\u4f5c\u7684\u5e76\u53d1\u6267\u884c\u8ba1\u65f6\u3002\u8fd9\u4e2a\u6846\u67b6\u7531\u4e00\u4e2a\u65b9\u6cd5\u7ec4\u6210\uff0c\u8be5\u65b9\u6cd5\u4f7f\u7528\u4e00\u4e2a executor \u6765\u6267\u884c\u64cd\u4f5c\uff0c\u4e00\u4e2a\u5e76\u53d1\u7ea7\u522b\u8868\u793a\u8981\u5e76\u53d1\u6267\u884c\u7684\u64cd\u4f5c\u7684\u6570\u91cf\uff0c\u4e00\u4e2a runnable \u8868\u793a\u64cd\u4f5c\u3002\u6240\u6709\u5de5\u4f5c\u7ebf\u7a0b\u90fd\u51c6\u5907\u5728 timer \u7ebf\u7a0b\u542f\u52a8\u65f6\u949f\u4e4b\u524d\u8fd0\u884c\u64cd\u4f5c\u3002\u5f53\u6700\u540e\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u51c6\u5907\u597d\u8fd0\u884c\u8be5\u64cd\u4f5c\u65f6\uff0c\u8ba1\u65f6\u5668\u7ebf\u7a0b\u300c\u53d1\u4ee4\u67aa\u300d\uff0c\u5141\u8bb8\u5de5\u4f5c\u7ebf\u7a0b\u6267\u884c\u8be5\u64cd\u4f5c\u3002\u4e00\u65e6\u6700\u540e\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u5b8c\u6210\u8be5\u64cd\u4f5c\uff0c\u8ba1\u65f6\u5668\u7ebf\u7a0b\u5c31\u505c\u6b62\u65f6\u949f\u3002\u5728 wait \u548c notify \u7684\u57fa\u7840\u4e0a\u76f4\u63a5\u5b9e\u73b0\u8fd9\u79cd\u903b\u8f91\u81f3\u5c11\u4f1a\u6709\u70b9\u9ebb\u70e6\uff0c\u4f46\u662f\u5728 CountDownLatch \u7684\u57fa\u7840\u4e0a\u5b9e\u73b0\u8d77\u6765\u5374\u975e\u5e38\u7b80\u5355\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Simple framework for timing concurrent execution\npublic static long time(Executor executor, int concurrency,Runnable action) throws InterruptedException {\n    CountDownLatch ready = new CountDownLatch(concurrency);\n    CountDownLatch start = new CountDownLatch(1);\n    CountDownLatch done = new CountDownLatch(concurrency);\n\n    for (int i = 0; i < concurrency; i++) {\n        executor.execute(() -> {\n            ready.countDown(); // Tell timer we're ready\n            try {\n                start.await(); // Wait till peers are ready\n                action.run();\n            } catch (InterruptedException e) {\n                Thread.currentThread().interrupt();\n            } finally {\n                done.countDown(); // Tell timer we're done\n            }\n        });\n    }\n\n    ready.await(); // Wait for all workers to be ready\n    long startNanos = System.nanoTime();\n    start.countDown(); // And they're off!\n    done.await(); // Wait for all workers to finish\n    return System.nanoTime() - startNanos;\n}\n")),(0,r.kt)("p",null,"Note that the method uses three countdown latches. The first, ready, is used by worker threads to tell the timer thread when they\u2019re ready. The worker threads then wait on the second latch, which is start. When the last worker thread invokes ready.countDown, the timer thread records the start time and invokes start.countDown, allowing all of the worker threads to proceed. Then the timer thread waits on the third latch, done, until the last of the worker threads finishes running the action and calls done.countDown. As soon as this happens, the timer thread awakens and records the end time."),(0,r.kt)("p",null,"\u6ce8\u610f\uff0c\u8be5\u65b9\u6cd5\u4f7f\u7528\u4e09\u4e2a\u5012\u8ba1\u65f6\u9501\u3002\u7b2c\u4e00\u4e2a\u662f ready\uff0c\u5de5\u4f5c\u7ebf\u7a0b\u4f7f\u7528\u5b83\u6765\u544a\u8bc9 timer \u7ebf\u7a0b\u5b83\u4eec\u4ec0\u4e48\u65f6\u5019\u51c6\u5907\u597d\u4e86\u3002\u5de5\u4f5c\u7ebf\u7a0b\u7136\u540e\u7b49\u5f85\u7b2c\u4e8c\u4e2a\u9501\u5b58\u5668\uff0c\u5373 start\u3002\u5f53\u6700\u540e\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"ready.countDown")," \u65f6\u3002timer \u7ebf\u7a0b\u8bb0\u5f55\u5f00\u59cb\u65f6\u95f4\u5e76\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"start.countDown"),"\uff0c\u5141\u8bb8\u6240\u6709\u5de5\u4f5c\u7ebf\u7a0b\u7ee7\u7eed\u3002\u7136\u540e\u8ba1\u65f6\u5668\u7ebf\u7a0b\u7b49\u5f85\u7b2c\u4e09\u4e2a\u9501\u5b58\u5668 done\uff0c\u76f4\u5230\u6700\u540e\u4e00\u4e2a\u5de5\u4f5c\u7ebf\u7a0b\u8fd0\u884c\u5b8c\u64cd\u4f5c\u5e76\u8c03\u7528 ",(0,r.kt)("inlineCode",{parentName:"p"},"done.countDown"),"\u3002\u4e00\u65e6\u53d1\u751f\u8fd9\u79cd\u60c5\u51b5\uff0ctimer \u7ebf\u7a0b\u5c31\u4f1a\u5524\u9192\u5e76\u8bb0\u5f55\u7ed3\u675f\u65f6\u95f4\u3002"),(0,r.kt)("p",null,"A few more details bear noting. The executor passed to the time method must allow for the creation of at least as many threads as the given concurrency level, or the test will never complete. This is known as a thread starvation deadlock ","[Goetz06, 8.1.1]",". If a worker thread catches an InterruptedException, it reasserts the interrupt using the idiom Thread.currentThread().interrupt() and returns from its run method. This allows the executor to deal with the interrupt as it sees fit. Note that System.nanoTime is used to time the activity. ",(0,r.kt)("strong",{parentName:"p"},"For interval timing, always use System.nanoTime rather than System.currentTimeMillis.")," System.nanoTime is both more accurate and more precise and is unaffected by adjustments to the system\u2019s realtime clock. Finally, note that the code in this example won\u2019t yield accurate timings unless action does a fair amount of work, say a second or more. Accurate microbenchmarking is notoriously hard and is best done with the aid of a specialized framework such as jmh ","[JMH]","."),(0,r.kt)("p",null,"\u8fd8\u6709\u4e00\u4e9b\u7ec6\u8282\u503c\u5f97\u6ce8\u610f\u3002\u4f20\u9012\u7ed9 time \u65b9\u6cd5\u7684 executor \u5fc5\u987b\u5141\u8bb8\u521b\u5efa\u81f3\u5c11\u4e0e\u7ed9\u5b9a\u5e76\u53d1\u7ea7\u522b\u76f8\u540c\u6570\u91cf\u7684\u7ebf\u7a0b\uff0c\u5426\u5219\u6d4b\u8bd5\u5c06\u6c38\u8fdc\u4e0d\u4f1a\u5b8c\u6210\u3002\u8fd9\u88ab\u79f0\u4e3a\u7ebf\u7a0b\u9965\u997f\u6b7b\u9501 ","[Goetz06, 8.1.1]","\u3002\u5982\u679c\u5de5\u4f5c\u7ebf\u7a0b\u6355\u6349\u5230 InterruptedException\uff0c\u5b83\u4f7f\u7528\u4e60\u60ef\u7528\u6cd5 ",(0,r.kt)("inlineCode",{parentName:"p"},"Thread.currentThread().interrupt()")," \u91cd\u7533\u4e2d\u65ad\uff0c\u5e76\u4ece\u5b83\u7684 run \u65b9\u6cd5\u8fd4\u56de\u3002\u8fd9\u5141\u8bb8\u6267\u884c\u7a0b\u5e8f\u6309\u7167\u5b83\u8ba4\u4e3a\u5408\u9002\u7684\u65b9\u5f0f\u5904\u7406\u4e2d\u65ad\u3002\u8bf7\u6ce8\u610f\uff0c",(0,r.kt)("inlineCode",{parentName:"p"},"System.nanoTime")," \u662f\u7528\u6765\u8ba1\u65f6\u7684\u3002",(0,r.kt)("strong",{parentName:"p"},"\u5bf9\u4e8e\u95f4\u9694\u8ba1\u65f6\uff0c\u59cb\u7ec8\u4f7f\u7528 ",(0,r.kt)("inlineCode",{parentName:"strong"},"System.nanoTime")," \u800c\u4e0d\u662f ",(0,r.kt)("inlineCode",{parentName:"strong"},"System.currentTimeMillis"),"\u3002")," ",(0,r.kt)("inlineCode",{parentName:"p"},"System.nanoTime")," \u4e0d\u4ec5\u66f4\u51c6\u786e\uff0c\u800c\u4e14\u66f4\u7cbe\u786e\uff0c\u800c\u4e14\u4e0d\u53d7\u7cfb\u7edf\u5b9e\u65f6\u65f6\u949f\u8c03\u6574\u7684\u5f71\u54cd\u3002\u6700\u540e\uff0c\u8bf7\u6ce8\u610f\uff0c\u672c\u4f8b\u4e2d\u7684\u4ee3\u7801\u4e0d\u4f1a\u4ea7\u751f\u51c6\u786e\u7684\u8ba1\u65f6\uff0c\u9664\u975e action \u505a\u4e86\u76f8\u5f53\u591a\u7684\u5de5\u4f5c\uff0c\u6bd4\u5982\u4e00\u79d2\u949f\u6216\u66f4\u957f\u65f6\u95f4\u3002\u51c6\u786e\u7684\u5fae\u57fa\u51c6\u6d4b\u8bd5\u662f\u51fa\u4e86\u540d\u7684\u56f0\u96be\uff0c\u6700\u597d\u662f\u501f\u52a9\u8bf8\u5982 jmh \u8fd9\u6837\u7684\u4e13\u4e1a\u6846\u67b6\u6765\u5b8c\u6210\u3002"),(0,r.kt)("p",null,"This item only scratches the surface of what you can do with the concurrency utilities. For example, the three countdown latches in the previous example could be replaced by a single CyclicBarrier or Phaser instance. The resulting code would be a bit more concise but perhaps more difficult to understand."),(0,r.kt)("p",null,"\u672c\u6761\u76ee\u53ea\u6d89\u53ca\u5230\u4f60\u53ef\u4ee5\u4f7f\u7528\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\u505a\u4ec0\u4e48\u3002\u4f8b\u5982\uff0c\u524d\u9762\u793a\u4f8b\u4e2d\u7684\u4e09\u4e2a\u5012\u8ba1\u65f6\u9501\u5b58\u5668\u53ef\u4ee5\u66ff\u6362\u4e3a\u5355\u4e2a CyclicBarrier \u6216 Phaser \u5b9e\u4f8b\u3002\u751f\u6210\u7684\u4ee3\u7801\u53ef\u80fd\u66f4\u7b80\u6d01\uff0c\u4f46\u53ef\u80fd\u66f4\u96be\u4e8e\u7406\u89e3\u3002"),(0,r.kt)("p",null,"While you should always use the concurrency utilities in preference to wait and notify, you might have to maintain legacy code that uses wait and notify. The wait method is used to make a thread wait for some condition. It must be invoked inside a synchronized region that locks the object on which it is invoked. Here is the standard idiom for using the wait method:"),(0,r.kt)("p",null,"\u867d\u7136\u4f60\u5e94\u8be5\u59cb\u7ec8\u4f18\u5148\u4f7f\u7528\u5e76\u53d1\u5b9e\u7528\u5de5\u5177\uff0c\u800c\u4e0d\u662f\u4f7f\u7528 wait \u548c notify\uff0c\u4f46\u662f\u4f60\u53ef\u80fd\u5fc5\u987b\u7ef4\u62a4\u4f7f\u7528 wait \u548c notify \u7684\u9057\u7559\u4ee3\u7801\u3002wait \u65b9\u6cd5\u7528\u4e8e\u4f7f\u7ebf\u7a0b\u7b49\u5f85\u67d0\u4e2a\u6761\u4ef6\u3002\u5b83\u5fc5\u987b\u5728\u540c\u6b65\u533a\u57df\u5185\u8c03\u7528\uff0c\u8be5\u540c\u6b65\u533a\u57df\u5c06\u9501\u5b9a\u8c03\u7528\u5b83\u7684\u5bf9\u8c61\u3002\u4e0b\u9762\u662f\u4f7f\u7528 wait \u65b9\u6cd5\u7684\u6807\u51c6\u5f62\u5f0f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// The standard idiom for using the wait method\nsynchronized (obj) {\n    while (<condition does not hold>)\n        obj.wait(); // (Releases lock, and reacquires on wakeup)\n    ... // Perform action appropriate to condition\n}\n")),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Always use the wait loop idiom to invoke the wait method; never invoke it outside of a loop.")," The loop serves to test the condition before and after waiting."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"\u59cb\u7ec8\u4f7f\u7528 wait \u4e60\u60ef\u7528\u6cd5\uff0c\u5373\u5faa\u73af\u6765\u8c03\u7528 wait \u65b9\u6cd5\uff1b\u6c38\u8fdc\u4e0d\u8981\u5728\u5faa\u73af\u4e4b\u5916\u8c03\u7528\u5b83\u3002")," \u5faa\u73af\u7528\u4e8e\u5728\u7b49\u5f85\u4e4b\u524d\u548c\u4e4b\u540e\u6d4b\u8bd5\u6761\u4ef6\u3002"),(0,r.kt)("p",null,"Testing the condition before waiting and skipping the wait if the condition already holds are necessary to ensure liveness. If the condition already holds and the notify (or notifyAll) method has already been invoked before a thread waits, there is no guarantee that the thread will ever wake from the wait."),(0,r.kt)("p",null,"\u5728\u7b49\u5f85\u4e4b\u524d\u6d4b\u8bd5\u6761\u4ef6\uff0c\u5982\u679c\u6761\u4ef6\u5df2\u7ecf\u5b58\u5728\uff0c\u5219\u8df3\u8fc7\u7b49\u5f85\uff0c\u4ee5\u786e\u4fdd\u6d3b\u6027\u3002\u5982\u679c\u6761\u4ef6\u5df2\u7ecf\u5b58\u5728\uff0c\u5e76\u4e14\u5728\u7ebf\u7a0b\u7b49\u5f85\u4e4b\u524d\u5df2\u7ecf\u8c03\u7528\u4e86 notify\uff08\u6216 notifyAll\uff09\u65b9\u6cd5\uff0c\u5219\u4e0d\u80fd\u4fdd\u8bc1\u7ebf\u7a0b\u5c06\u4ece\u7b49\u5f85\u4e2d\u5524\u9192\u3002"),(0,r.kt)("p",null,"Testing the condition after waiting and waiting again if the condition does not hold are necessary to ensure safety. If the thread proceeds with the action when the condition does not hold, it can destroy the invariant guarded by the lock. There are several reasons a thread might wake up when the condition does not hold:"),(0,r.kt)("p",null,"\u4e3a\u4e86\u786e\u4fdd\u5b89\u5168\uff0c\u9700\u8981\u5728\u7b49\u5f85\u4e4b\u540e\u518d\u6d4b\u8bd5\u6761\u4ef6\uff0c\u5982\u679c\u6761\u4ef6\u4e0d\u6210\u7acb\uff0c\u5219\u518d\u6b21\u7b49\u5f85\u3002\u5982\u679c\u7ebf\u7a0b\u5728\u6761\u4ef6\u4e0d\u6210\u7acb\u7684\u60c5\u51b5\u4e0b\u7ee7\u7eed\u6267\u884c\u8be5\u64cd\u4f5c\uff0c\u5b83\u53ef\u80fd\u4f1a\u7834\u574f\u7531\u9501\u4fdd\u62a4\u7684\u4e0d\u53d8\u6027\u3002\u5f53\u6761\u4ef6\u4e0d\u6210\u7acb\u65f6\uff0c\u6709\u4e00\u4e9b\u7406\u7531\u5524\u9192\u7ebf\u7a0b\uff1a"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Another thread could have obtained the lock and changed the guarded state between the time a thread invoked notify and the waiting thread woke up.")),(0,r.kt)("p",null,"\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u83b7\u5f97\u9501\uff0c\u5e76\u5728\u7ebf\u7a0b\u8c03\u7528 notify \u548c\u7b49\u5f85\u7ebf\u7a0b\u9192\u6765\u4e4b\u95f4\u66f4\u6539\u4fdd\u62a4\u72b6\u6001\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"Another thread could have invoked notify accidentally or maliciously when the condition did not hold. Classes expose themselves to this sort of mischief by waiting on publicly accessible objects. Any wait in a synchronized method of a publicly accessible object is susceptible to this problem.")),(0,r.kt)("p",null,"\u5f53\u6761\u4ef6\u4e0d\u6210\u7acb\u65f6\uff0c\u53e6\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u80fd\u610f\u5916\u5730\u6216\u6076\u610f\u5730\u8c03\u7528 notify\u3002\u7c7b\u901a\u8fc7\u7b49\u5f85\u516c\u5171\u53ef\u8bbf\u95ee\u7684\u5bf9\u8c61\u6765\u66b4\u9732\u81ea\u5df1\u3002\u516c\u5171\u53ef\u8bbf\u95ee\u5bf9\u8c61\u7684\u540c\u6b65\u65b9\u6cd5\u4e2d\u7684\u4efb\u4f55 wait \u90fd\u5bb9\u6613\u53d7\u5230\u8fd9\u4e2a\u95ee\u9898\u7684\u5f71\u54cd\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The notifying thread could be overly \u201cgenerous\u201d in waking waiting threads. For example, the notifying thread might invoke notifyAll even if only some of the waiting threads have their condition satisfied.")),(0,r.kt)("p",null,"\u901a\u77e5\u7ebf\u7a0b\u5728\u5524\u9192\u7b49\u5f85\u7ebf\u7a0b\u65f6\u53ef\u80fd\u8fc7\u4e8e\u300c\u6177\u6168\u300d\u3002\u4f8b\u5982\uff0c\u5373\u4f7f\u53ea\u6709\u4e00\u4e9b\u7b49\u5f85\u7ebf\u7a0b\u7684\u6761\u4ef6\u5f97\u5230\u6ee1\u8db3\uff0c\u901a\u77e5\u7ebf\u7a0b\u4e5f\u53ef\u80fd\u8c03\u7528 notifyAll\u3002"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"The waiting thread could (rarely) wake up in the absence of a notify. This is known as a spurious wakeup ","[POSIX, 11.4.3.6.1; Java9-api]",".")),(0,r.kt)("p",null,"\u5728\u6ca1\u6709\u901a\u77e5\u7684\u60c5\u51b5\u4e0b\uff0c\u7b49\u5f85\u7684\u7ebf\u7a0b\u53ef\u80fd\uff08\u5f88\u5c11\uff09\u9192\u6765\u3002\u8fd9\u88ab\u79f0\u4e3a\u4f2a\u5524\u9192 ","[POSIX, 11.4.3.6.1; Java9-api]","\u3002"),(0,r.kt)("p",null,"A related issue is whether to use notify or notifyAll to wake waiting threads. (Recall that notify wakes a single waiting thread, assuming such a thread exists, and notifyAll wakes all waiting threads.) It is sometimes said that you should always use notifyAll. This is reasonable, conservative advice. It will always yield correct results because it guarantees that you\u2019ll wake the threads that need to be awakened. You may wake some other threads, too, but this won\u2019t affect the correctness of your program. These threads will check the condition for which they\u2019re waiting and, finding it false, will continue waiting."),(0,r.kt)("p",null,"\u4e00\u4e2a\u76f8\u5173\u7684\u95ee\u9898\u662f\uff0c\u662f\u4f7f\u7528 notify \u8fd8\u662f notifyAll \u6765\u5524\u9192\u7b49\u5f85\u7684\u7ebf\u7a0b\u3002\uff08\u56de\u60f3\u4e00\u4e0b notify \u5524\u9192\u4e00\u4e2a\u7b49\u5f85\u7ebf\u7a0b\uff0c\u5047\u8bbe\u5b58\u5728\u8fd9\u6837\u4e00\u4e2a\u7ebf\u7a0b\uff0cnotifyAll \u5524\u9192\u6240\u6709\u7b49\u5f85\u7ebf\u7a0b)\u3002\u6709\u65f6\u4eba\u4eec\u4f1a\u8bf4\uff0c\u5e94\u8be5\u59cb\u7ec8\u4f7f\u7528 notifyAll\u3002\u8fd9\u662f\u5408\u7406\u7684\u3001\u4fdd\u5b88\u7684\u5efa\u8bae\u3002\u5b83\u603b\u662f\u4f1a\u4ea7\u751f\u6b63\u786e\u7684\u7ed3\u679c\uff0c\u56e0\u4e3a\u5b83\u4fdd\u8bc1\u4f60\u5c06\u5524\u9192\u9700\u8981\u5524\u9192\u7684\u7ebf\u7a0b\u3002\u4f60\u53ef\u80fd\u8fd8\u4f1a\u5524\u9192\u5176\u4ed6\u4e00\u4e9b\u7ebf\u7a0b\uff0c\u4f46\u8fd9\u4e0d\u4f1a\u5f71\u54cd\u7a0b\u5e8f\u7684\u6b63\u786e\u6027\u3002\u8fd9\u4e9b\u7ebf\u7a0b\u5c06\u68c0\u67e5\u5b83\u4eec\u6b63\u5728\u7b49\u5f85\u7684\u6761\u4ef6\uff0c\u5982\u679c\u53d1\u73b0\u4e3a\u6761\u4ef6\u4e0d\u6ee1\u8db3\uff0c\u5c06\u7ee7\u7eed\u7b49\u5f85\u3002"),(0,r.kt)("p",null,"As an optimization, you may choose to invoke notify instead of notifyAll if all threads that could be in the wait-set are waiting for the same condition and only one thread at a time can benefit from the condition becoming true."),(0,r.kt)("p",null,"\u4f5c\u4e3a\u4e00\u79cd\u4f18\u5316\uff0c\u5982\u679c\u5728\u7b49\u5f85\u72b6\u6001\u7684\u6240\u6709\u7ebf\u7a0b\u90fd\u5728\u7b49\u5f85\u76f8\u540c\u7684\u6761\u4ef6\uff0c\u5e76\u4e14\u6bcf\u6b21\u53ea\u6709\u4e00\u4e2a\u7ebf\u7a0b\u53ef\u4ee5\u4ece\u6761\u4ef6\u4e2d\u83b7\u76ca\uff0c\u90a3\u4e48\u4f60\u53ef\u4ee5\u9009\u62e9\u8c03\u7528 notify \u800c\u4e0d\u662f notifyAll\u3002"),(0,r.kt)("p",null,"Even if these preconditions are satisfied, there may be cause to use notifyAll in place of notify. Just as placing the wait invocation in a loop protects against accidental or malicious notifications on a publicly accessible object, using notifyAll in place of notify protects against accidental or malicious waits by an unrelated thread. Such waits could otherwise \u201cswallow\u201d a critical notification, leaving its intended recipient waiting indefinitely."),(0,r.kt)("p",null,"\u5373\u4f7f\u6ee1\u8db3\u4e86\u8fd9\u4e9b\u5148\u51b3\u6761\u4ef6\uff0c\u4e5f\u53ef\u80fd\u6709\u7406\u7531\u4f7f\u7528 notifyAll \u6765\u4ee3\u66ff notify\u3002\u6b63\u5982\u5c06 wait \u8c03\u7528\u653e\u5728\u5faa\u73af\u4e2d\u53ef\u4ee5\u9632\u6b62\u516c\u5171\u8bbf\u95ee\u5bf9\u8c61\u4e0a\u7684\u610f\u5916\u6216\u6076\u610f\u901a\u77e5\u4e00\u6837\uff0c\u4f7f\u7528 notifyAll \u4ee3\u66ff notify \u53ef\u4ee5\u9632\u6b62\u4e0d\u76f8\u5173\u7ebf\u7a0b\u7684\u610f\u5916\u6216\u6076\u610f\u7b49\u5f85\u3002\u5426\u5219\uff0c\u8fd9\u6837\u7684\u7b49\u5f85\u53ef\u80fd\u4f1a\u300c\u541e\u4e0b\u300d\u4e00\u4e2a\u5173\u952e\u901a\u77e5\uff0c\u8ba9\u9884\u671f\u7684\u63a5\u6536\u8005\u65e0\u9650\u671f\u5730\u7b49\u5f85\u3002"),(0,r.kt)("p",null,"In summary, using wait and notify directly is like programming in \u201cconcurrency assembly language,\u201d as compared to the higher-level language provided by java.util.concurrent. ",(0,r.kt)("strong",{parentName:"p"},"There is seldom, if ever, a reason to use wait and notify in new code.")," If you maintain code that uses wait and notify, make sure that it always invokes wait from within a while loop using the standard idiom. The notifyAll method should generally be used in preference to notify. If notify is used, great care must be taken to ensure liveness."),(0,r.kt)("p",null,"\u603b\u4e4b\uff0c\u4e0e ",(0,r.kt)("inlineCode",{parentName:"p"},"java.util.concurrent")," \u63d0\u4f9b\u7684\u9ad8\u7ea7\u8bed\u8a00\u76f8\u6bd4\uff0c\u76f4\u63a5\u4f7f\u7528 wait \u548c notify \u5c31\u50cf\u4f7f\u7528\u300c\u5e76\u53d1\u6c47\u7f16\u8bed\u8a00\u300d\u7f16\u7a0b\u4e00\u6837\u539f\u59cb\u3002",(0,r.kt)("strong",{parentName:"p"},"\u5728\u65b0\u4ee3\u7801\u4e2d\u5f88\u5c11\u6709\u7406\u7531\u4f7f\u7528 wait \u548c notify\u3002")," \u5982\u679c\u7ef4\u62a4\u4f7f\u7528 wait \u548c notify \u7684\u4ee3\u7801\uff0c\u8bf7\u786e\u4fdd\u5b83\u59cb\u7ec8\u4f7f\u7528\u6807\u51c6\u7684\u4e60\u60ef\u7528\u6cd5\uff0c\u5373\u5728 while \u5faa\u73af\u4e2d\u8c03\u7528 wait\u3002\u53e6\u5916\uff0cnotifyAll \u65b9\u6cd5\u901a\u5e38\u5e94\u8be5\u4f18\u5148\u4e8e notify\u3002\u5982\u679c\u4f7f\u7528 notify\uff0c\u5219\u5fc5\u987b\u975e\u5e38\u5c0f\u5fc3\u4ee5\u786e\u4fdd\u5176\u6d3b\u6027\u3002"),(0,r.kt)("hr",null),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"./Chapter-11/Chapter-11-Introduction"},"Back to contents of the chapter\uff08\u8fd4\u56de\u7ae0\u8282\u76ee\u5f55\uff09"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Previous Item\uff08\u4e0a\u4e00\u6761\u76ee\uff09\uff1a",(0,r.kt)("a",{parentName:"strong",href:"./Chapter-11/Chapter-11-Item-80-Prefer-executors,-tasks,-and-streams-to-threads"},"Item 80: Prefer executors, tasks, and streams to threads\uff08Executor\u3001task\u3001\u6d41\u4f18\u4e8e\u76f4\u63a5\u4f7f\u7528\u7ebf\u7a0b\uff09"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Next Item\uff08\u4e0b\u4e00\u6761\u76ee\uff09\uff1a",(0,r.kt)("a",{parentName:"strong",href:"./Chapter-11/Chapter-11-Item-82-Document-thread-safety"},"Item 82: Document thread safety\uff08\u6587\u6863\u5e94\u5305\u542b\u7ebf\u7a0b\u5b89\u5168\u5c5e\u6027\uff09")))))}h.isMDXComponent=!0}}]);