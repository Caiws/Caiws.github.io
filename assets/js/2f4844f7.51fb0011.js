"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7809],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>u});var i=a(7294);function n(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,i)}return a}function s(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){n(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function o(e,t){if(null==e)return{};var a,i,n=function(e,t){if(null==e)return{};var a,i,n={},r=Object.keys(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||(n[a]=e[a]);return n}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)a=r[i],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}var l=i.createContext({}),c=function(e){var t=i.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):s(s({},t),e)),a},p=function(e){var t=c(e.components);return i.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},d=i.forwardRef((function(e,t){var a=e.components,n=e.mdxType,r=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),d=c(a),u=n,m=d["".concat(l,".").concat(u)]||d[u]||h[u]||r;return a?i.createElement(m,s(s({ref:t},p),{},{components:a})):i.createElement(m,s({ref:t},p))}));function u(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var r=a.length,s=new Array(r);s[0]=d;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o.mdxType="string"==typeof e?e:n,s[1]=o;for(var c=2;c<r;c++)s[c]=a[c];return i.createElement.apply(null,s)}return i.createElement.apply(null,a)}d.displayName="MDXCreateElement"},3491:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>o,toc:()=>c});var i=a(7462),n=(a(7294),a(3905));const r={},s=void 0,o={unversionedId:"Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances",id:"Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances",title:"Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances",description:"Chapter 12. Serialization\uff08\u5e8f\u5217\u5316\uff09",source:"@site/docs/Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances.md",sourceDirName:"Books/EffectiveJava3/Chapter-12",slug:"/Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances",permalink:"/docs/Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Books/EffectiveJava3/Chapter-12/Chapter-12-Item-90-Consider-serialization-proxies-instead-of-serialized-instances.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Chapter-12-Item-89-For-instance-control-prefer-enum-types-to-readResolve",permalink:"/docs/Books/EffectiveJava3/Chapter-12/Chapter-12-Item-89-For-instance-control-prefer-enum-types-to-readResolve"},next:{title:"\u7b80\u4ecb",permalink:"/docs/Books/OnJava8/Introduction"}},l={},c=[{value:"Chapter 12. Serialization\uff08\u5e8f\u5217\u5316\uff09",id:"chapter-12-serialization\u5e8f\u5217\u5316",level:2},{value:"Item 90: Consider serialization proxies instead of serialized instances\uff08\u8003\u8651\u4ee5\u5e8f\u5217\u5316\u4ee3\u7406\u4ee3\u66ff\u5e8f\u5217\u5316\u5b9e\u4f8b\uff09",id:"item-90-consider-serialization-proxies-instead-of-serialized-instances\u8003\u8651\u4ee5\u5e8f\u5217\u5316\u4ee3\u7406\u4ee3\u66ff\u5e8f\u5217\u5316\u5b9e\u4f8b",level:3}],p={toc:c};function h(e){let{components:t,...a}=e;return(0,n.kt)("wrapper",(0,i.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,n.kt)("h2",{id:"chapter-12-serialization\u5e8f\u5217\u5316"},"Chapter 12. Serialization\uff08\u5e8f\u5217\u5316\uff09"),(0,n.kt)("h3",{id:"item-90-consider-serialization-proxies-instead-of-serialized-instances\u8003\u8651\u4ee5\u5e8f\u5217\u5316\u4ee3\u7406\u4ee3\u66ff\u5e8f\u5217\u5316\u5b9e\u4f8b"},"Item 90: Consider serialization proxies instead of serialized instances\uff08\u8003\u8651\u4ee5\u5e8f\u5217\u5316\u4ee3\u7406\u4ee3\u66ff\u5e8f\u5217\u5316\u5b9e\u4f8b\uff09"),(0,n.kt)("p",null,"As mentioned in Items 85 and 86 and discussed throughout this chapter, the decision to implement Serializable increases the likelihood of bugs and security problems as it allows instances to be created using an extralinguistic mechanism in place of ordinary constructors. There is, however, a technique that greatly reduces these risks. This technique is known as the serialization proxy pattern."),(0,n.kt)("p",null,"\u6b63\u5982\u5728 ",(0,n.kt)("a",{parentName:"p",href:"./Chapter-12/Chapter-12-Item-85-Prefer-alternatives-to-Java-serialization"},"Item-85")," \u548c ",(0,n.kt)("a",{parentName:"p",href:"./Chapter-12/Chapter-12-Item-86-Implement-Serializable-with-great-caution"},"Item-86")," \u4e2d\u63d0\u5230\u7684\u8d2f\u7a7f\u672c\u7ae0\u7684\u95ee\u9898\uff1a\u5b9e\u73b0 Serializable \u63a5\u53e3\u7684\u51b3\u5b9a\u589e\u52a0\u4e86\u51fa\u73b0 bug \u548c\u5b89\u5168\u95ee\u9898\u7684\u53ef\u80fd\u6027\uff0c\u56e0\u4e3a\u5b83\u5141\u8bb8\u4f7f\u7528\u4e00\u79cd\u8d85\u8bed\u8a00\u673a\u5236\u6765\u521b\u5efa\u5b9e\u4f8b\uff0c\u800c\u4e0d\u662f\u4f7f\u7528\u666e\u901a\u7684\u6784\u9020\u51fd\u6570\u3002\u7136\u800c\uff0c\u6709\u4e00\u79cd\u6280\u672f\u53ef\u4ee5\u5927\u5927\u964d\u4f4e\u8fd9\u4e9b\u98ce\u9669\u3002\u8fd9\u79cd\u6280\u672f\u79f0\u4e3a\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u3002"),(0,n.kt)("p",null,"The serialization proxy pattern is reasonably straightforward. First, design a private static nested class that concisely represents the logical state of an instance of the enclosing class. This nested class is known as the serialization proxy of the enclosing class. It should have a single constructor, whose parameter type is the enclosing class. This constructor merely copies the data from its argument: it need not do any consistency checking or defensive copying. By design, the default serialized form of the serialization proxy is the perfect serialized form of the enclosing class. Both the enclosing class and its serialization proxy must be declared to implement Serializable."),(0,n.kt)("p",null,"\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u76f8\u5f53\u7b80\u5355\u3002\u9996\u5148\uff0c\u8bbe\u8ba1\u4e00\u4e2a\u79c1\u6709\u9759\u6001\u5d4c\u5957\u7c7b\uff0c\u5b83\u7b80\u6d01\u5730\u8868\u793a\u5916\u56f4\u7c7b\u5b9e\u4f8b\u7684\u903b\u8f91\u72b6\u6001\u3002\u8fd9\u4e2a\u5d4c\u5957\u7c7b\u79f0\u4e3a\u5916\u56f4\u7c7b\u7684\u5e8f\u5217\u5316\u4ee3\u7406\u3002\u5b83\u5e94\u8be5\u6709\u4e00\u4e2a\u6784\u9020\u51fd\u6570\uff0c\u5176\u53c2\u6570\u7c7b\u578b\u662f\u5916\u56f4\u7c7b\u3002\u8fd9\u4e2a\u6784\u9020\u51fd\u6570\u53ea\u662f\u4ece\u5b83\u7684\u53c2\u6570\u590d\u5236\u6570\u636e\uff1a\u5b83\u4e0d\u9700\u8981\u505a\u4efb\u4f55\u4e00\u81f4\u6027\u68c0\u67e5\u6216\u9632\u5fa1\u6027\u590d\u5236\u3002\u6309\u7167\u8bbe\u8ba1\uff0c\u5e8f\u5217\u5316\u4ee3\u7406\u7684\u9ed8\u8ba4\u5e8f\u5217\u5316\u5f62\u5f0f\u662f\u5916\u56f4\u7c7b\u7684\u5b8c\u7f8e\u5e8f\u5217\u5316\u5f62\u5f0f\u3002\u5916\u56f4\u7c7b\u53ca\u5176\u5e8f\u5217\u4ee3\u7406\u90fd\u5fc5\u987b\u58f0\u660e\u5b9e\u73b0 Serializable \u63a5\u53e3\u3002"),(0,n.kt)("p",null,"For example, consider the immutable Period class written in Item 50 and made serializable in Item 88. Here is a serialization proxy for this class. Period is so simple that its serialization proxy has exactly the same fields as the class:"),(0,n.kt)("p",null,"\u4f8b\u5982\uff0c\u8003\u8651 ",(0,n.kt)("a",{parentName:"p",href:"./Chapter-8-Item-50-Make-defensive-copies-when-needed"},"Item-50")," \u4e2d\u7f16\u5199\u7684\u4e0d\u53ef\u53d8 Period \u7c7b\uff0c\u5e76\u5728 ",(0,n.kt)("a",{parentName:"p",href:"./Chapter-12/Chapter-12-Item-88-Write-readObject-methods-defensively"},"Item-88")," \u4e2d\u4f7f\u5176\u53ef\u5e8f\u5217\u5316\u3002\u8fd9\u662f\u8be5\u7c7b\u7684\u5e8f\u5217\u5316\u4ee3\u7406\u3002Period \u975e\u5e38\u7b80\u5355\uff0c\u5b83\u7684\u5e8f\u5217\u5316\u4ee3\u7406\u5177\u6709\u4e0e\u7c7b\u5b8c\u5168\u76f8\u540c\u7684\u5b57\u6bb5\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"// Serialization proxy for Period class\nprivate static class SerializationProxy implements Serializable {\n    private final Date start;\n    private final Date end;\n    SerializationProxy(Period p) {\n        this.start = p.start;\n        this.end = p.end;\n    }\n    private static final long serialVersionUID =234098243823485285L; // Any number will do (Item 87)\n}\n")),(0,n.kt)("p",null,"Next, add the following writeReplace method to the enclosing class. This method can be copied verbatim into any class with a serialization proxy:"),(0,n.kt)("p",null,"\u63a5\u4e0b\u6765\uff0c\u5c06\u4ee5\u4e0b writeReplace \u65b9\u6cd5\u6dfb\u52a0\u5230\u5916\u56f4\u7c7b\u4e2d\u3002\u901a\u8fc7\u5e8f\u5217\u5316\u4ee3\u7406\uff0c\u8fd9\u4e2a\u65b9\u6cd5\u53ef\u4ee5\u88ab\u9010\u5b57\u5730\u590d\u5236\u5230\u4efb\u4f55\u7c7b\u4e2d\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"// writeReplace method for the serialization proxy pattern\nprivate Object writeReplace() {\n    return new SerializationProxy(this);\n}\n")),(0,n.kt)("p",null,"The presence of this method on the enclosing class causes the serialization system to emit a SerializationProxy instance instead of an instance of the enclosing class. In other words, the writeReplace method translates an instance of the enclosing class to its serialization proxy prior to serialization."),(0,n.kt)("p",null,"\u8be5\u65b9\u6cd5\u5b58\u5728\u4e8e\u5916\u56f4\u7c7b\uff0c\u5bfc\u81f4\u5e8f\u5217\u5316\u7cfb\u7edf\u4ea7\u751f SerializationProxy \u5b9e\u4f8b\uff0c\u800c\u4e0d\u662f\u5916\u56f4\u7c7b\u7684\u5b9e\u4f8b\u3002\u6362\u53e5\u8bdd\u8bf4\uff0cwriteReplace \u65b9\u6cd5\u5728\u5e8f\u5217\u5316\u4e4b\u524d\u5c06\u5916\u56f4\u7c7b\u7684\u5b9e\u4f8b\u8f6c\u6362\u4e3a\u5176\u5e8f\u5217\u5316\u4ee3\u7406\u3002"),(0,n.kt)("p",null,"With this writeReplace method in place, the serialization system will never generate a serialized instance of the enclosing class, but an attacker might fabricate one in an attempt to violate the class\u2019s invariants. To guarantee that such an attack would fail, merely add this readObject method to the enclosing class:"),(0,n.kt)("p",null,"\u6709\u4e86\u8fd9\u4e2a writeReplace \u65b9\u6cd5\uff0c\u5e8f\u5217\u5316\u7cfb\u7edf\u5c06\u6c38\u8fdc\u4e0d\u4f1a\u751f\u6210\u5916\u56f4\u7c7b\u7684\u5e8f\u5217\u5316\u5b9e\u4f8b\uff0c\u4f46\u662f\u653b\u51fb\u8005\u53ef\u80fd\u4f1a\u521b\u5efa\u4e00\u4e2a\u5b9e\u4f8b\uff0c\u8bd5\u56fe\u8fdd\u53cd\u7c7b\u7684\u4e0d\u53d8\u6027\u3002\u4e3a\u4e86\u4fdd\u8bc1\u8fd9\u6837\u7684\u653b\u51fb\u4f1a\u5931\u8d25\uff0c\u53ea\u9700\u5c06\u8fd9\u4e2a readObject \u65b9\u6cd5\u6dfb\u52a0\u5230\u5916\u56f4\u7c7b\u4e2d\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},'// readObject method for the serialization proxy pattern\nprivate void readObject(ObjectInputStream stream) throws InvalidObjectException {\n    throw new InvalidObjectException("Proxy required");\n}\n')),(0,n.kt)("p",null,"Finally, provide a readResolve method on the SerializationProxy class that returns a logically equivalent instance of the enclosing class. The presence of this method causes the serialization system to translate the serialization proxy back into an instance of the enclosing class upon deserialization."),(0,n.kt)("p",null,"\u6700\u540e\uff0c\u5728 SerializationProxy \u7c7b\u4e0a\u63d0\u4f9b\u4e00\u4e2a readResolve \u65b9\u6cd5\uff0c\u8be5\u65b9\u6cd5\u8fd4\u56de\u5916\u56f4\u7c7b\u7684\u903b\u8f91\u7b49\u6548\u5b9e\u4f8b\u3002\u6b64\u65b9\u6cd5\u7684\u5b58\u5728\u5bfc\u81f4\u5e8f\u5217\u5316\u7cfb\u7edf\u5728\u53cd\u5e8f\u5217\u5316\u65f6\u5c06\u5e8f\u5217\u5316\u4ee3\u7406\u8f6c\u6362\u56de\u5916\u56f4\u7c7b\u7684\u5b9e\u4f8b\u3002"),(0,n.kt)("p",null,"This readResolve method creates an instance of the enclosing class using only its public API and therein lies the beauty of the pattern. It largely eliminates the extralinguistic character of serialization, because the deserialized instance is created using the same constructors, static factories, and methods as any other instance. This frees you from having to separately ensure that deserialized instances obey the class\u2019s invariants. If the class\u2019s static factories or constructors establish these invariants and its instance methods maintain them, you\u2019ve ensured that the invariants will be maintained by serialization as well."),(0,n.kt)("p",null,"\u8fd9\u4e2a readResolve \u65b9\u6cd5\u4ec5\u4f7f\u7528\u5176\u516c\u5171 API \u521b\u5efa\u4e86\u4e00\u4e2a\u5916\u56f4\u7c7b\u7684\u5b9e\u4f8b\uff0c\u8fd9\u5c31\u662f\u8be5\u6a21\u5f0f\u7684\u7f8e\u5999\u4e4b\u5904\u3002\u5b83\u5728\u5f88\u5927\u7a0b\u5ea6\u4e0a\u6d88\u9664\u4e86\u5e8f\u5217\u5316\u7684\u8bed\u8a00\u5916\u7279\u6027\uff0c\u56e0\u4e3a\u53cd\u5e8f\u5217\u5316\u5b9e\u4f8b\u662f\u4f7f\u7528\u4e0e\u4efb\u4f55\u5176\u4ed6\u5b9e\u4f8b\u76f8\u540c\u7684\u6784\u9020\u51fd\u6570\u3001\u9759\u6001\u5de5\u5382\u548c\u65b9\u6cd5\u521b\u5efa\u7684\u3002\u8fd9\u4f7f\u4f60\u4e0d\u5fc5\u5355\u72ec\u786e\u4fdd\u53cd\u5e8f\u5217\u5316\u7684\u5b9e\u4f8b\u9075\u4ece\u7c7b\u7684\u4e0d\u53d8\u6027\u3002\u5982\u679c\u7c7b\u7684\u9759\u6001\u5de5\u5382\u6216\u6784\u9020\u51fd\u6570\u5efa\u7acb\u4e86\u8fd9\u4e9b\u4e0d\u53d8\u6027\uff0c\u800c\u5b83\u7684\u5b9e\u4f8b\u65b9\u6cd5\u7ef4\u62a4\u5b83\u4eec\uff0c\u90a3\u4e48\u4f60\u5c31\u786e\u4fdd\u4e86\u8fd9\u4e9b\u4e0d\u53d8\u6027\u4e5f\u5c06\u901a\u8fc7\u5e8f\u5217\u5316\u6765\u7ef4\u62a4\u3002"),(0,n.kt)("p",null,"Here is the readResolve method for Period.SerializationProxy above:"),(0,n.kt)("p",null,"\u4ee5\u4e0b\u662f\u4e0a\u8ff0 ",(0,n.kt)("inlineCode",{parentName:"p"},"Period.SerializationProxy")," \u7684 readResolve \u65b9\u6cd5\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"// readResolve method for Period.SerializationProxy\nprivate Object readResolve() {\n    return new Period(start, end); // Uses public constructor\n}\n")),(0,n.kt)("p",null,"Like the defensive copying approach (page 357), the serialization proxy approach stops the bogus byte-stream attack (page 354) and the internal field theft attack (page 356) dead in their tracks. Unlike the two previous approaches, this one allows the fields of Period to be final, which is required in order for the Period class to be truly immutable (Item 17). And unlike the two previous approaches, this one doesn\u2019t involve a great deal of thought. You don\u2019t have to figure out which fields might be compromised by devious serialization attacks, nor do you have to explicitly perform validity checking as part of deserialization."),(0,n.kt)("p",null,"\u4e0e\u9632\u5fa1\u6027\u590d\u5236\u65b9\u6cd5\uff08\u7b2c 357 \u9875\uff09\u7c7b\u4f3c\uff0c\u5e8f\u5217\u5316\u4ee3\u7406\u65b9\u6cd5\u963b\u6b62\u4f2a\u5b57\u8282\u6d41\u653b\u51fb\uff08\u7b2c 354 \u9875\uff09\u548c\u5185\u90e8\u5b57\u6bb5\u76d7\u7a83\u653b\u51fb\uff08\u7b2c 356 \u9875\uff09\u3002\u4e0e\u524d\u4e24\u79cd\u65b9\u6cd5\u4e0d\u540c\uff0c\u8fd9\u79cd\u65b9\u6cd5\u5141\u8bb8 Period \u7684\u5b57\u6bb5\u4e3a final\uff0c\u8fd9\u662f Period \u7c7b\u771f\u6b63\u4e0d\u53ef\u53d8\u6240\u5fc5\u9700\u7684\uff08",(0,n.kt)("a",{parentName:"p",href:"./Chapter-4-Item-17-Minimize-mutability"},"Item-17"),"\uff09\u3002\u4e0e\u524d\u4e24\u79cd\u65b9\u6cd5\u4e0d\u540c\uff0c\u8fd9\u4e00\u79cd\u65b9\u6cd5\u4e0d\u9700\u8981\u592a\u591a\u7684\u601d\u8003\u3002\u4f60\u4e0d\u5fc5\u6307\u51fa\u54ea\u4e9b\u5b57\u6bb5\u53ef\u80fd\u4f1a\u53d7\u5230\u72e1\u733e\u7684\u5e8f\u5217\u5316\u653b\u51fb\u7684\u5371\u5bb3\uff0c\u4e5f\u4e0d\u5fc5\u663e\u5f0f\u5730\u6267\u884c\u6709\u6548\u6027\u68c0\u67e5\u4f5c\u4e3a\u53cd\u5e8f\u5217\u5316\u7684\u4e00\u90e8\u5206\u3002"),(0,n.kt)("p",null,"There is another way in which the serialization proxy pattern is more powerful than defensive copying in readObject. The serialization proxy pattern allows the deserialized instance to have a different class from the originally serialized instance. You might not think that this would be useful in practice, but it is."),(0,n.kt)("p",null,"\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u8fd8\u6709\u53e6\u4e00\u79cd\u65b9\u5f0f\u6bd4 readObject \u4e2d\u7684\u9632\u5fa1\u6027\u590d\u5236\u66f4\u5f3a\u5927\u3002\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u5141\u8bb8\u53cd\u5e8f\u5217\u5316\u5b9e\u4f8b\u5177\u6709\u4e0e\u521d\u59cb\u5e8f\u5217\u5316\u5b9e\u4f8b\u4e0d\u540c\u7684\u7c7b\u3002\u4f60\u53ef\u80fd\u4e0d\u8ba4\u4e3a\u8fd9\u5728\u5b9e\u8df5\u4e2d\u6709\u7528\uff0c\u4f46\u5b83\u786e\u5b9e\u6709\u7528\u3002"),(0,n.kt)("p",null,"Consider the case of EnumSet (Item 36). This class has no public constructors, only static factories. From the client\u2019s perspective, they return EnumSet instances, but in the current OpenJDK implementation, they return one of two subclasses, depending on the size of the underlying enum type. If the underlying enum type has sixty-four or fewer elements, the static factories return a RegularEnumSet; otherwise, they return a JumboEnumSet."),(0,n.kt)("p",null,"\u8003\u8651 EnumSet \u7684\u60c5\u51b5\uff08",(0,n.kt)("a",{parentName:"p",href:"./Chapter-6-Item-36-Use-EnumSet-instead-of-bit-fields"},"Item-36"),"\uff09\u3002\u8be5\u7c7b\u6ca1\u6709\u516c\u5171\u6784\u9020\u51fd\u6570\uff0c\u53ea\u6709\u9759\u6001\u5de5\u5382\u3002\u4ece\u5ba2\u6237\u7aef\u7684\u89d2\u5ea6\u6765\u770b\uff0c\u5b83\u4eec\u8fd4\u56de EnumSet \u5b9e\u4f8b\uff0c\u4f46\u662f\u5728\u5f53\u524d OpenJDK \u5b9e\u73b0\u4e2d\uff0c\u5b83\u4eec\u8fd4\u56de\u4e24\u4e2a\u5b50\u7c7b\u4e2d\u7684\u4e00\u4e2a\uff0c\u5177\u4f53\u53d6\u51b3\u4e8e\u5e95\u5c42\u679a\u4e3e\u7c7b\u578b\u7684\u5927\u5c0f\u3002\u5982\u679c\u5e95\u5c42\u679a\u4e3e\u7c7b\u578b\u6709 64 \u4e2a\u6216\u66f4\u5c11\u7684\u5143\u7d20\uff0c\u5219\u9759\u6001\u5de5\u5382\u8fd4\u56de\u4e00\u4e2a RegularEnumSet\uff1b\u5426\u5219\uff0c\u5b83\u4eec\u8fd4\u56de\u4e00\u4e2a JumboEnumSet\u3002"),(0,n.kt)("p",null,"Now consider what happens if you serialize an enum set whose enum type has sixty elements, then add five more elements to the enum type, and then deserialize the enum set. It was a RegularEnumSet instance when it was serialized, but it had better be a JumboEnumSet instance once it is deserialized. In fact that\u2019s exactly what happens, because EnumSet uses the serialization proxy pattern. In case you\u2019re curious, here is EnumSet\u2019s serialization proxy. It really is this simple:"),(0,n.kt)("p",null,"\u73b0\u5728\u8003\u8651\uff0c\u5982\u679c\u5e8f\u5217\u5316\u4e00\u4e2a\u679a\u4e3e\u96c6\u5408\uff0c\u5b83\u7684\u679a\u4e3e\u7c7b\u578b\u6709 60 \u4e2a\u5143\u7d20\uff0c\u7136\u540e\u7ed9\u8fd9\u4e2a\u679a\u4e3e\u7c7b\u578b\u518d\u589e\u52a0 5 \u4e2a\u5143\u7d20\uff0c\u4e4b\u540e\u53cd\u5e8f\u5217\u5316\u8fd9\u4e2a\u679a\u4e3e\u96c6\u5408\u3002\u5f53\u5b83\u88ab\u5e8f\u5217\u5316\u7684\u65f6\u5019\uff0c\u8fd4\u56de RegularEnumSet \u5b9e\u4f8b\uff0c\u4f46\u6700\u597d\u662f JumboEnumSet \u5b9e\u4f8b\u3002\u4e8b\u5b9e\u4e0a\u6b63\u662f\u8fd9\u6837\uff0c\u56e0\u4e3a EnumSet \u4f7f\u7528\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u3002\u5982\u679c\u4f60\u597d\u5947\uff0c\u8fd9\u91cc\u662f EnumSet \u7684\u5e8f\u5217\u5316\u4ee3\u7406\u3002\u5176\u5b9e\u5f88\u7b80\u5355\uff1a"),(0,n.kt)("pre",null,(0,n.kt)("code",{parentName:"pre"},"// EnumSet's serialization proxy\nprivate static class SerializationProxy <E extends Enum<E>> implements Serializable {\n    // The element type of this enum set.\n    private final Class<E> elementType;\n\n    // The elements contained in this enum set.\n    private final Enum<?>[] elements;\n\n    SerializationProxy(EnumSet<E> set) {\n        elementType = set.elementType;\n        elements = set.toArray(new Enum<?>[0]);\n    }\n\n    private Object readResolve() {\n        EnumSet<E> result = EnumSet.noneOf(elementType);\n        for (Enum<?> e : elements)\n            result.add((E)e);\n        return result;\n    }\n\n    private static final long serialVersionUID =362491234563181265L;\n}\n")),(0,n.kt)("p",null,"The serialization proxy pattern has two limitations. It is not compatible with classes that are extendable by their users (Item 19). Also, it is not compatible with some classes whose object graphs contain circularities: if you attempt to invoke a method on such an object from within its serialization proxy\u2019s readResolve method, you\u2019ll get a ClassCastException because you don\u2019t have the object yet, only its serialization proxy."),(0,n.kt)("p",null,"\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u6709\u4e24\u4e2a\u9650\u5236\u3002\u5b83\u4e0e\u5ba2\u6237\u7aef\u53ef\u6269\u5c55\u7684\u7c7b\u4e0d\u517c\u5bb9\uff08",(0,n.kt)("a",{parentName:"p",href:"./Chapter-4-Item-19-Design-and-document-for-inheritance-or-else-prohibit-it"},"Item-19"),"\uff09\u3002\u800c\u4e14\uff0c\u5b83\u4e5f\u4e0d\u80fd\u4e0e\u5bf9\u8c61\u56fe\u4e2d\u5305\u542b\u5faa\u73af\u7684\u67d0\u4e9b\u7c7b\u517c\u5bb9\uff1a\u5982\u679c\u4f60\u8bd5\u56fe\u4ece\u5bf9\u8c61\u7684\u5e8f\u5217\u5316\u4ee3\u7406\u7684 readResolve \u65b9\u6cd5\u4e2d\u8c03\u7528\u5bf9\u8c61\u4e0a\u7684\u65b9\u6cd5\uff0c\u4f60\u5c06\u5f97\u5230\u4e00\u4e2a ClassCastException\uff0c\u56e0\u4e3a\u4f60\u8fd8\u6ca1\u6709\u5bf9\u8c61\uff0c\u53ea\u6709\u5bf9\u8c61\u7684\u5e8f\u5217\u5316\u4ee3\u7406\u3002"),(0,n.kt)("p",null,"Finally, the added power and safety of the serialization proxy pattern are not free. On my machine, it is 14 percent more expensive to serialize and deserialize Period instances with serialization proxies than it is with defensive copying."),(0,n.kt)("p",null,"\u6700\u540e\uff0c\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u6240\u589e\u5f3a\u7684\u529f\u80fd\u548c\u5b89\u5168\u6027\u5e76\u4e0d\u662f\u6ca1\u6709\u4ee3\u4ef7\u7684\u3002\u5728\u6211\u7684\u673a\u5668\u4e0a\uff0c\u901a\u8fc7\u5e8f\u5217\u5316\u4ee3\u7406\u6765\u5e8f\u5217\u5316\u548c\u53cd\u5e8f\u5217\u5316 Period \u5b9e\u4f8b\u7684\u5f00\u9500\uff0c\u6bd4\u7528\u4fdd\u62a4\u6027\u62f7\u8d1d\u8fdb\u884c\u7684\u5f00\u9500\u589e\u52a0\u4e8614%\u3002"),(0,n.kt)("p",null,"In summary, consider the serialization proxy pattern whenever you find yourself having to write a readObject or writeObject method on a class that is not extendable by its clients. This pattern is perhaps the easiest way to robustly serialize objects with nontrivial invariants."),(0,n.kt)("p",null,"\u603b\u4e4b\uff0c\u5f53\u4f60\u53d1\u73b0\u5fc5\u987b\u5728\u5ba2\u6237\u7aef\u4e0d\u53ef\u6269\u5c55\u7684\u7c7b\u4e0a\u7f16\u5199 readObject \u6216 writeObject \u65b9\u6cd5\u65f6\uff0c\u8bf7\u8003\u8651\u5e8f\u5217\u5316\u4ee3\u7406\u6a21\u5f0f\u3002\u8981\u60f3\u7a33\u5065\u5730\u5c06\u5e26\u6709\u91cd\u8981\u7ea6\u675f\u6761\u4ef6\u7684\u5bf9\u8c61\u5e8f\u5217\u5316\u65f6\uff0c\u8fd9\u79cd\u6a21\u5f0f\u53ef\u80fd\u662f\u6700\u5bb9\u6613\u7684\u65b9\u6cd5\u3002"),(0,n.kt)("hr",null),(0,n.kt)("p",null,(0,n.kt)("strong",{parentName:"p"},(0,n.kt)("a",{parentName:"strong",href:"./Chapter-12/Chapter-12-Introduction"},"Back to contents of the chapter\uff08\u8fd4\u56de\u7ae0\u8282\u76ee\u5f55\uff09"))),(0,n.kt)("ul",null,(0,n.kt)("li",{parentName:"ul"},(0,n.kt)("strong",{parentName:"li"},"Previous Item\uff08\u4e0a\u4e00\u6761\u76ee\uff09\uff1a",(0,n.kt)("a",{parentName:"strong",href:"./Chapter-12/Chapter-12-Item-89-For-instance-control-prefer-enum-types-to-readResolve"},"Item 89: For instance control prefer enum types to readResolve\uff08\u5bf9\u4e8e\u5b9e\u4f8b\u63a7\u5236\uff0c\u679a\u4e3e\u7c7b\u578b\u4f18\u4e8e readResolve\uff09")))))}h.isMDXComponent=!0}}]);