"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[7214],{3905:(e,t,a)=>{a.d(t,{Zo:()=>p,kt:()=>d});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=n.createContext({}),c=function(e){var t=n.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=c(e.components);return n.createElement(l.Provider,{value:t},e.children)},h={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},u=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,p=s(e,["components","mdxType","originalType","parentName"]),u=c(a),d=r,m=u["".concat(l,".").concat(d)]||u[d]||h[d]||o;return a?n.createElement(m,i(i({ref:t},p),{},{components:a})):n.createElement(m,i({ref:t},p))}));function d(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,i=new Array(o);i[0]=u;var s={};for(var l in t)hasOwnProperty.call(t,l)&&(s[l]=t[l]);s.originalType=e,s.mdxType="string"==typeof e?e:r,i[1]=s;for(var c=2;c<o;c++)i[c]=a[c];return n.createElement.apply(null,i)}return n.createElement.apply(null,a)}u.displayName="MDXCreateElement"},3864:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>l,contentTitle:()=>i,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var n=a(7462),r=(a(7294),a(3905));const o={},i=void 0,s={unversionedId:"Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed",id:"Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed",title:"Chapter-8-Item-50-Make-defensive-copies-when-needed",description:"Chapter 8. Methods\uff08\u65b9\u6cd5\uff09",source:"@site/docs/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed.md",sourceDirName:"Books/EffectiveJava3/Chapter-8",slug:"/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed",permalink:"/docs/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed",draft:!1,editUrl:"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-50-Make-defensive-copies-when-needed.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Chapter-8-Item-49-Check-parameters-for-validity",permalink:"/docs/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-49-Check-parameters-for-validity"},next:{title:"Chapter-8-Item-51-Design-method-signatures-carefully",permalink:"/docs/Books/EffectiveJava3/Chapter-8/Chapter-8-Item-51-Design-method-signatures-carefully"}},l={},c=[{value:"Chapter 8. Methods\uff08\u65b9\u6cd5\uff09",id:"chapter-8-methods\u65b9\u6cd5",level:2},{value:"Item 50: Make defensive copies when needed\uff08\u5728\u9700\u8981\u65f6\u5236\u4f5c\u9632\u5fa1\u6027\u526f\u672c\uff09",id:"item-50-make-defensive-copies-when-needed\u5728\u9700\u8981\u65f6\u5236\u4f5c\u9632\u5fa1\u6027\u526f\u672c",level:3}],p={toc:c};function h(e){let{components:t,...a}=e;return(0,r.kt)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h2",{id:"chapter-8-methods\u65b9\u6cd5"},"Chapter 8. Methods\uff08\u65b9\u6cd5\uff09"),(0,r.kt)("h3",{id:"item-50-make-defensive-copies-when-needed\u5728\u9700\u8981\u65f6\u5236\u4f5c\u9632\u5fa1\u6027\u526f\u672c"},"Item 50: Make defensive copies when needed\uff08\u5728\u9700\u8981\u65f6\u5236\u4f5c\u9632\u5fa1\u6027\u526f\u672c\uff09"),(0,r.kt)("p",null,"One thing that makes Java a pleasure to use is that it is a safe language. This means that in the absence of native methods it is immune to buffer overruns, array overruns, wild pointers, and other memory corruption errors that plague unsafe languages such as C and C++. In a safe language, it is possible to write classes and to know with certainty that their invariants will hold, no matter what happens in any other part of the system. This is not possible in languages that treat all of memory as one giant array."),(0,r.kt)("p",null,"Java \u662f\u4e00\u79cd\u5b89\u5168\u7684\u8bed\u8a00\uff0c\u8fd9\u662f\u5b83\u7684\u4e00\u5927\u4f18\u70b9\u3002\u8fd9\u610f\u5473\u7740\u5728\u6ca1\u6709\u672c\u5730\u65b9\u6cd5\u7684\u60c5\u51b5\u4e0b\uff0c\u5b83\u4e0d\u53d7\u7f13\u51b2\u533a\u6ea2\u51fa\u3001\u6570\u7ec4\u6ea2\u51fa\u3001\u975e\u6cd5\u6307\u9488\u548c\u5176\u4ed6\u5185\u5b58\u635f\u574f\u9519\u8bef\u7684\u5f71\u54cd\uff0c\u8fd9\u4e9b\u9519\u8bef\u56f0\u6270\u7740 C \u548c c++ \u7b49\u4e0d\u5b89\u5168\u8bed\u8a00\u3002\u5728\u4e00\u79cd\u5b89\u5168\u7684\u8bed\u8a00\u4e2d\uff0c\u53ef\u4ee5\u7f16\u5199\u4e00\u4e2a\u7c7b\u5e76\u786e\u5b9a\u5b83\u4eec\u7684\u4e0d\u53d8\u91cf\u5c06\u4fdd\u6301\u4e0d\u53d8\uff0c\u800c\u4e0d\u7ba1\u5728\u7cfb\u7edf\u7684\u4efb\u4f55\u5176\u4ed6\u90e8\u5206\u53d1\u751f\u4e86\u4ec0\u4e48\u3002\u5728\u5c06\u6240\u6709\u5185\u5b58\u89c6\u4e3a\u4e00\u4e2a\u5de8\u5927\u6570\u7ec4\u7684\u8bed\u8a00\u4e2d\uff0c\u8fd9\u662f\u4e0d\u53ef\u80fd\u7684\u3002"),(0,r.kt)("p",null,"Even in a safe language, you aren\u2019t insulated from other classes without some effort on your part. ",(0,r.kt)("strong",{parentName:"p"},"You must program defensively, with the assumption that clients of your class will do their best to destroy its invariants.")," This is increasingly true as people try harder to break the security of systems, but more commonly, your class will have to cope with unexpected behavior resulting from the honest mistakes of well-intentioned programmers. Either way, it is worth taking the time to write classes that are robust in the face of ill-behaved clients."),(0,r.kt)("p",null,"\u5373\u4f7f\u4f7f\u7528\u4e00\u79cd\u5b89\u5168\u7684\u8bed\u8a00\uff0c\u5982\u679c\u4f60\u4e0d\u4ed8\u51fa\u4e00\u4e9b\u52aa\u529b\uff0c\u4e5f\u65e0\u6cd5\u4e0e\u5176\u4ed6\u7c7b\u9694\u79bb\u3002",(0,r.kt)("strong",{parentName:"p"},"\u4f60\u5fc5\u987b\u8fdb\u884c\u9632\u5fa1\u6027\u7684\u8bbe\u8ba1\uff0c\u5e76\u5047\u5b9a\u4f60\u7684\u7c7b\u7684\u5ba2\u6237\u7aef\u4f1a\u5c3d\u6700\u5927\u52aa\u529b\u7834\u574f\u5b83\u7684\u4e0d\u53d8\u91cf\u3002")," \u968f\u7740\u4eba\u4eec\u8d8a\u6765\u8d8a\u591a\u5730\u5c1d\u8bd5\u7834\u574f\u7cfb\u7edf\u7684\u5b89\u5168\u6027\uff0c\u8fd9\u4e2a\u89c2\u70b9\u8d8a\u6765\u8d8a\u6b63\u786e\uff0c\u4f46\u66f4\u5e38\u89c1\u7684\u60c5\u51b5\u662f\uff0c\u4f60\u7684\u7c7b\u5c06\u4e0d\u5f97\u4e0d\u5904\u7406\u7a0b\u5e8f\u5458\u7684\u65e0\u610f\u9519\u8bef\u6240\u5bfc\u81f4\u7684\u610f\u5916\u884c\u4e3a\u3002\u65e0\u8bba\u54ea\u79cd\u65b9\u5f0f\uff0c\u90fd\u503c\u5f97\u82b1\u65f6\u95f4\u7f16\u5199\u4e00\u4e2a\u5065\u58ee\u7684\u7c7b\u6765\u9762\u5bf9\u884c\u4e3a\u4e0d\u8f68\u7684\u5ba2\u6237\u7aef\u3002"),(0,r.kt)("p",null,"While it is impossible for another class to modify an object\u2019s internal state without some assistance from the object, it is surprisingly easy to provide such assistance without meaning to do so. For example, consider the following class, which purports to represent an immutable time period:"),(0,r.kt)("p",null,"\u867d\u7136\u5982\u679c\u6ca1\u6709\u5bf9\u8c61\u7684\u5e2e\u52a9\uff0c\u53e6\u4e00\u4e2a\u7c7b\u662f\u4e0d\u53ef\u80fd\u4fee\u6539\u5bf9\u8c61\u7684\u5185\u90e8\u72b6\u6001\u7684\uff0c\u4f46\u662f\u8981\u63d0\u4f9b\u8fd9\u6837\u7684\u5e2e\u52a9\u5374\u51fa\u5947\u5730\u5bb9\u6613\u3002\u4f8b\u5982\uff0c\u8003\u8651\u4e0b\u9762\u7684\u7c7b\uff0c\u5b83\u8868\u793a\u4e00\u4e2a\u4e0d\u53ef\u53d8\u7684\u65f6\u95f4\u6bb5\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'// Broken "immutable" time period class\npublic final class Period {\n    private final Date start;\n    private final Date end;\n\n    /**\n    * @param start the beginning of the period\n    * @param end the end of the period; must not precede start\n    * @throws IllegalArgumentException if start is after end\n    * @throws NullPointerException if start or end is null\n    */\n    public Period(Date start, Date end) {\n        if (start.compareTo(end) > 0)\n            throw new IllegalArgumentException(start + " after " + end);\n        this.start = start;\n        this.end = end;\n    }\n\n    public Date start() {\n        return start;\n    }\n\n    public Date end() {\n        return end;\n    }\n    ... // Remainder omitted\n}\n')),(0,r.kt)("p",null,"At first glance, this class may appear to be immutable and to enforce the invariant that the start of a period does not follow its end. It is, however, easy to violate this invariant by exploiting the fact that Date is mutable:"),(0,r.kt)("p",null,"\u4e4d\u4e00\u770b\uff0c\u8fd9\u4e2a\u7c7b\u4f3c\u4e4e\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5e76\u4e14\u8981\u6c42\u4e00\u4e2a\u65f6\u95f4\u6bb5\u7684\u5f00\u59cb\u65f6\u95f4\u4e0d\u80fd\u5728\u7ed3\u675f\u65f6\u95f4\u4e4b\u540e\u3002\u7136\u800c\uff0c\u5229\u7528 Date \u662f\u53ef\u53d8\u7684\u8fd9\u4e00\u4e8b\u5b9e\u5f88\u5bb9\u6613\u7ed5\u8fc7\u8fd9\u4e2a\u7ea6\u675f\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Attack the internals of a Period instance\nDate start = new Date();\nDate end = new Date();\nPeriod p = new Period(start, end);\nend.setYear(78); // Modifies internals of p!\n")),(0,r.kt)("p",null,"As of Java 8, the obvious way to fix this problem is to use Instant (or Local-DateTime or ZonedDateTime) in place of a Date because Instant (and the other java.time classes) are immutable (Item 17). ",(0,r.kt)("strong",{parentName:"p"},"Date is obsolete and should no longer be used in new code.")," That said, the problem still exists: there are times when you\u2019ll have to use mutable value types in your APIs and internal representations, and the techniques discussed in this item are appropriate for those times."),(0,r.kt)("p",null,"\u4ece Java 8 \u5f00\u59cb\uff0c\u89e3\u51b3\u8fd9\u4e2a\u95ee\u9898\u7684\u5178\u578b\u65b9\u6cd5\u5c31\u662f\u4f7f\u7528 Instant\uff08\u6216 Local-DateTime \u6216 ZonedDateTime\uff09\u6765\u4ee3\u66ff Date\uff0c\u56e0\u4e3a Instant\uff08\u548c\u5176\u4ed6\u65f6\u95f4\u7c7b\uff09\u7c7b\u662f\u4e0d\u53ef\u53d8\u7684\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-4-Item-17-Minimize-mutability"},"Item-17"),"\uff09\u3002",(0,r.kt)("strong",{parentName:"p"},"Date \u5df2\u8fc7\u65f6\uff0c\u4e0d\u5e94\u5728\u65b0\u4ee3\u7801\u4e2d\u4f7f\u7528\u3002")," \u5c3d\u7ba1\u5982\u6b64\uff0c\u95ee\u9898\u4ecd\u7136\u5b58\u5728\uff1a\u6709\u65f6\u4f60\u5fc5\u987b\u5728 API \u548c\u5185\u90e8\u8868\u793a\u4e2d\u4f7f\u7528\u53ef\u53d8\u503c\u7c7b\u578b\uff0c\u672c\u9879\u76ee\u4e2d\u8ba8\u8bba\u7684\u6280\u672f\u9002\u7528\u4e8e\u8fd9\u4e9b\u60c5\u5f62\u3002"),(0,r.kt)("p",null,"To protect the internals of a Period instance from this sort of attack, ",(0,r.kt)("strong",{parentName:"p"},"it is essential to make a defensive copy of each mutable parameter to the constructor")," and to use the copies as components of the Period instance in place of the originals:"),(0,r.kt)("p",null,"\u4e3a\u4e86\u4fdd\u62a4 Period \u5b9e\u4f8b\u7684\u5185\u90e8\u4e0d\u53d7\u6b64\u7c7b\u653b\u51fb\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u5fc5\u987b\u5c06\u6bcf\u4e2a\u53ef\u53d8\u53c2\u6570\u7684\u9632\u5fa1\u6027\u526f\u672c\u590d\u5236\u7ed9\u6784\u9020\u51fd\u6570"),"\uff0c\u5e76\u5c06\u526f\u672c\u7528\u4f5c Period \u5b9e\u4f8b\u7684\u7ec4\u4ef6\uff0c\u800c\u4e0d\u662f\u539f\u59cb\u7ec4\u4ef6\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},'// Repaired constructor - makes defensive copies of parameters\npublic Period(Date start, Date end) {\n    this.start = new Date(start.getTime());\n    this.end = new Date(end.getTime());\n    if (this.start.compareTo(this.end) > 0)\n        throw new IllegalArgumentException(this.start + " after " + this.end);\n}\n')),(0,r.kt)("p",null,"With the new constructor in place, the previous attack will have no effect on the Period instance. Note that ",(0,r.kt)("strong",{parentName:"p"},"defensive copies are made before checking the validity of the parameters (Item 49), and the validity check is performed on the copies rather than on the originals.")," While this may seem unnatural, it is necessary. It protects the class against changes to the parameters from another thread during the window of vulnerability between the time the parameters are checked and the time they are copied. In the computer security community, this is known as a time-of-check/time-of-use or TOCTOU attack ","[Viega01]","."),(0,r.kt)("p",null,"\u6709\u4e86\u65b0\u7684\u6784\u9020\u51fd\u6570\uff0c\u4e4b\u524d\u7684\u653b\u51fb\u5c06\u4e0d\u4f1a\u5bf9 Period \u5b9e\u4f8b\u4ea7\u751f\u5f71\u54cd\u3002\u6ce8\u610f\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u9632\u5fa1\u6027\u526f\u672c\u662f\u5728\u68c0\u67e5\u53c2\u6570\u7684\u6709\u6548\u6027\u4e4b\u524d\u5236\u4f5c\u7684\uff08",(0,r.kt)("a",{parentName:"strong",href:"./Chapter-8-Item-49-Check-parameters-for-validity"},"Item-49"),"\uff09\uff0c\u6709\u6548\u6027\u68c0\u67e5\u662f\u5728\u526f\u672c\u4e0a\u800c\u4e0d\u662f\u5728\u6b63\u672c\u4e0a\u6267\u884c\u7684\u3002")," \u867d\u7136\u8fd9\u770b\u8d77\u6765\u4e0d\u81ea\u7136\uff0c\u4f46\u5374\u662f\u5fc5\u8981\u7684\u3002\u5728\u68c0\u67e5\u53c2\u6570\u548c\u590d\u5236\u53c2\u6570\u4e4b\u95f4\u7684\u7a7a\u7a97\u671f\uff0c\u5b83\u4fdd\u62a4\u7c7b\u4e0d\u53d7\u6765\u81ea\u5176\u4ed6\u7ebf\u7a0b\u7684\u53c2\u6570\u66f4\u6539\u7684\u5f71\u54cd\u3002\u5728\u8ba1\u7b97\u673a\u5b89\u5168\u793e\u533a\u91cc\uff0c\u8fd9\u88ab\u79f0\u4e3a time-of-check/time-of-use \u6216 TOCTOU \u653b\u51fb ","[Viega01]","\u3002"),(0,r.kt)("p",null,"Note also that we did not use Date\u2019s clone method to make the defensive copies. Because Date is nonfinal, the clone method is not guaranteed to return an object whose class is java.util.Date: it could return an instance of an untrusted subclass that is specifically designed for malicious mischief. Such a subclass could, for example, record a reference to each instance in a private static list at the time of its creation and allow the attacker to access this list. This would give the attacker free rein over all instances. To prevent this sort of attack, ",(0,r.kt)("strong",{parentName:"p"},"do not use the clone method to make a defensive copy of a parameter whose type is subclassable by untrusted parties.")),(0,r.kt)("p",null,"\u8fd8\u8981\u6ce8\u610f\uff0c\u6211\u4eec\u6ca1\u6709\u4f7f\u7528 Date \u7684 clone \u65b9\u6cd5\u6765\u521b\u5efa\u9632\u5fa1\u6027\u526f\u672c\u3002\u56e0\u4e3a Date \u4e0d\u662f final \u7684\uff0c\u6240\u4ee5\u4e0d\u80fd\u4fdd\u8bc1 clone \u65b9\u6cd5\u8fd4\u56de\u4e00\u4e2a java.util.Date \u7684\u5b9e\u4f8b\u5bf9\u8c61\uff1a\u5b83\u53ef\u4ee5\u8fd4\u56de\u4e00\u4e2a\u4e0d\u53d7\u4fe1\u4efb\u5b50\u7c7b\u7684\u5b9e\u4f8b\uff0c\u8fd9\u4e2a\u5b50\u7c7b\u662f\u4e13\u95e8\u4e3a\u6076\u610f\u7834\u574f\u800c\u8bbe\u8ba1\u7684\u3002\u4f8b\u5982\uff0c\u8fd9\u6837\u7684\u5b50\u7c7b\u53ef\u4ee5\u5728\u521b\u5efa\u65f6\u5728\u79c1\u6709\u9759\u6001\u5217\u8868\u4e2d\u8bb0\u5f55\u5bf9\u6bcf\u4e2a\u5b9e\u4f8b\u7684\u5f15\u7528\uff0c\u5e76\u5141\u8bb8\u653b\u51fb\u8005\u8bbf\u95ee\u8fd9\u4e2a\u5217\u8868\u3002\u8fd9\u5c06\u4f7f\u653b\u51fb\u8005\u53ef\u4ee5\u81ea\u7531\u63a7\u5236\u6240\u6709\u5b9e\u4f8b\u3002\u4e3a\u9632\u6b62\u6b64\u7c7b\u653b\u51fb\uff0c",(0,r.kt)("strong",{parentName:"p"},"\u5bf9\u53ef\u88ab\u4e0d\u53d7\u4fe1\u4efb\u65b9\u5b50\u7c7b\u5316\u7684\u53c2\u6570\u7c7b\u578b\uff0c\u4e0d\u8981\u4f7f\u7528 clone \u65b9\u6cd5\u8fdb\u884c\u9632\u5fa1\u6027\u590d\u5236\u3002")),(0,r.kt)("p",null,"While the replacement constructor successfully defends against the previous attack, it is still possible to mutate a Period instance, because its accessors offer access to its mutable internals:"),(0,r.kt)("p",null,"\u867d\u7136\u66ff\u6362\u6784\u9020\u51fd\u6570\u6210\u529f\u5730\u9632\u5fa1\u4e86\u4e4b\u524d\u7684\u653b\u51fb\uff0c\u4f46\u662f\u4ecd\u7136\u53ef\u4ee5\u4fee\u6539 Period \u5b9e\u4f8b\uff0c\u56e0\u4e3a\u5b83\u7684\u8bbf\u95ee\u5668\u63d0\u4f9b\u4e86\u5bf9\u5176\u53ef\u53d8\u5185\u90e8\u7ed3\u6784\u7684\u8bbf\u95ee\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Second attack on the internals of a Period instance\nDate start = new Date();\nDate end = new Date();\nPeriod p = new Period(start, end);\np.end().setYear(78); // Modifies internals of p!\n")),(0,r.kt)("p",null,"To defend against the second attack, merely modify the accessors to return defensive copies of mutable internal fields:"),(0,r.kt)("p",null,"\u8981\u9632\u5fa1\u7b2c\u4e8c\u6b21\u653b\u51fb\uff0c\u53ea\u9700\u4fee\u6539\u8bbf\u95ee\u5668\uff0c\u8fd4\u56de\u53ef\u53d8\u5185\u90e8\u5b57\u6bb5\u7684\u9632\u5fa1\u526f\u672c\uff1a"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"// Repaired accessors - make defensive copies of internal fields\npublic Date start() {\n    return new Date(start.getTime());\n}\n\npublic Date end() {\n    return new Date(end.getTime());\n}\n")),(0,r.kt)("p",null,"With the new constructor and the new accessors in place, Period is truly immutable. No matter how malicious or incompetent a programmer, there is simply no way to violate the invariant that the start of a period does not follow its end (without resorting to extralinguistic means such as native methods and reflection). This is true because there is no way for any class other than Period itself to gain access to either of the mutable fields in a Period instance. These fields are truly encapsulated within the object."),(0,r.kt)("p",null,"\u6709\u4e86\u65b0\u7684\u6784\u9020\u51fd\u6570\u548c\u65b0\u7684\u8bbf\u95ee\u5668\uff0cPeriod \u5b9e\u9645\u4e0a\u662f\u4e0d\u53ef\u53d8\u7684\u3002\u65e0\u8bba\u7a0b\u5e8f\u5458\u591a\u4e48\u6076\u6bd2\u6216\u65e0\u80fd\uff0c\u90fd\u4e0d\u53ef\u80fd\u8fdd\u80cc\u4e00\u4e2a\u65f6\u95f4\u6bb5\u7684\u5f00\u59cb\u65f6\u95f4\u4e0d\u80fd\u5728\u7ed3\u675f\u65f6\u95f4\u4e4b\u540e\u8fd9\u4e00\u4e0d\u53d8\u6761\u4ef6\uff08\u9664\u975e\u4f7f\u7528\u8bf8\u5982\u672c\u5730\u65b9\u6cd5\u548c\u53cd\u5c04\u4e4b\u7c7b\u7684\u5916\u90e8\u8bed\u8a00\u624b\u6bb5\uff09\u3002\u8fd9\u662f\u771f\u7684\uff0c\u56e0\u4e3a\u9664\u4e86 Period \u672c\u8eab\u4e4b\u5916\uff0c\u4efb\u4f55\u7c7b\u90fd\u65e0\u6cd5\u8bbf\u95ee Period \u5b9e\u4f8b\u4e2d\u7684\u4efb\u4f55\u53ef\u53d8\u5b57\u6bb5\u3002\u8fd9\u4e9b\u5b57\u6bb5\u771f\u6b63\u5c01\u88c5\u5728\u5bf9\u8c61\u4e2d\u3002"),(0,r.kt)("p",null,"In the accessors, unlike the constructor, it would be permissible to use the clone method to make the defensive copies. This is so because we know that the class of Period\u2019s internal Date objects is java.util.Date, and not some untrusted subclass. That said, you are generally better off using a constructor or static factory to copy an instance, for reasons outlined in Item 13."),(0,r.kt)("p",null,"\u5728\u8bbf\u95ee\u5668\u4e2d\uff0c\u4e0e\u6784\u9020\u51fd\u6570\u4e0d\u540c\uff0c\u53ef\u4ee5\u4f7f\u7528 clone \u65b9\u6cd5\u8fdb\u884c\u9632\u5fa1\u6027\u590d\u5236\u3002\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u77e5\u9053 Period \u7684\u5185\u90e8 Date \u5bf9\u8c61\u7684\u7c7b\u662f ",(0,r.kt)("inlineCode",{parentName:"p"},"java.util.Date"),"\uff0c\u800c\u4e0d\u662f\u67d0\u4e2a\u4e0d\u53ef\u4fe1\u7684\u5b50\u7c7b\u3002\u4e5f\u5c31\u662f\u8bf4\uff0c\u57fa\u4e8e ",(0,r.kt)("a",{parentName:"p",href:"./Chapter-3-Item-13-Override-clone-judiciously"},"Item-13")," \u4e2d\u5217\u51fa\u7684\u539f\u56e0\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6700\u597d\u4f7f\u7528\u6784\u9020\u51fd\u6570\u6216\u9759\u6001\u5de5\u5382\u6765\u590d\u5236\u5b9e\u4f8b\u3002"),(0,r.kt)("p",null,"Defensive copying of parameters is not just for immutable classes. Any time you write a method or constructor that stores a reference to a client-provided object in an internal data structure, think about whether the client-provided object is potentially mutable. If it is, think about whether your class could tolerate a change in the object after it was entered into the data structure. If the answer is no, you must defensively copy the object and enter the copy into the data structure in place of the original. For example, if you are considering using a client-provided object reference as an element in an internal Set instance or as a key in an internal Map instance, you should be aware that the invariants of the set or map would be corrupted if the object were modified after it is inserted."),(0,r.kt)("p",null,"\u53c2\u6570\u7684\u9632\u5fa1\u6027\u590d\u5236\u4e0d\u4ec5\u9002\u7528\u4e8e\u4e0d\u53ef\u53d8\u7c7b\u3002\u5728\u7f16\u5199\u65b9\u6cd5\u6216\u6784\u9020\u51fd\u6570\u65f6\uff0c\u5982\u679c\u8981\u5728\u5185\u90e8\u6570\u636e\u7ed3\u6784\u4e2d\u5b58\u50a8\u5bf9\u5ba2\u6237\u7aef\u63d0\u4f9b\u7684\u5bf9\u8c61\u7684\u5f15\u7528\uff0c\u8bf7\u8003\u8651\u5ba2\u6237\u7aef\u63d0\u4f9b\u7684\u5bf9\u8c61\u662f\u5426\u53ef\u80fd\u662f\u53ef\u53d8\u7684\u3002\u5982\u679c\u662f\uff0c\u8bf7\u8003\u8651\u8be5\u5bf9\u8c61\u8fdb\u5165\u6570\u636e\u7ed3\u6784\u4e4b\u540e\uff0c\u4f60\u7684\u7c7b\u662f\u5426\u80fd\u591f\u5bb9\u5fcd\u8be5\u5bf9\u8c61\u53d1\u751f\u66f4\u6539\u3002\u5982\u679c\u7b54\u6848\u662f\u5426\u5b9a\u7684\uff0c\u5219\u5fc5\u987b\u9632\u5fa1\u6027\u5730\u590d\u5236\u5bf9\u8c61\uff0c\u5e76\u5c06\u526f\u672c\u8f93\u5165\u5230\u6570\u636e\u7ed3\u6784\u4e2d\uff0c\u800c\u4e0d\u662f\u539f\u59cb\u6b63\u672c\u3002\u4e3e\u4e2a\u4f8b\u5b50\uff0c\u5982\u679c\u4f60\u6b63\u5728\u8003\u8651\u4f7f\u7528\u7531\u5ba2\u6237\u63d0\u4f9b\u7684\u5bf9\u8c61\u5f15\u7528\u4f5c\u4e3a\u5185\u90e8 Set \u5b9e\u4f8b\u7684\u5143\u7d20\uff0c\u6216\u8005\u4f5c\u4e3a\u5185\u90e8 Map \u5b9e\u4f8b\u7684\u952e, \u5c31\u5e94\u8be5\u610f\u8bc6\u5230\u5982\u679c\u8fd9\u4e2a\u5bf9\u8c61\u5728\u63d2\u5165\u4e4b\u540e\u53d1\u751f\u6539\u53d8\uff0cSet \u6216\u8005 Map \u7684\u7ea6\u675f\u6761\u4ef6\u5c31\u4f1a\u906d\u5230\u7834\u574f\u3002"),(0,r.kt)("p",null,"The same is true for defensive copying of internal components prior to returning them to clients. Whether or not your class is immutable, you should think twice before returning a reference to an internal component that is mutable. Chances are, you should return a defensive copy. Remember that nonzero-length arrays are always mutable. Therefore, you should always make a defensive copy of an internal array before returning it to a client. Alternatively, you could return an immutable view of the array. Both of these techniques are shown in Item 15."),(0,r.kt)("p",null,"\u5728\u5c06\u5185\u90e8\u7ec4\u4ef6\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u4e4b\u524d\u5e94\u5bf9\u5176\u8fdb\u884c\u9632\u5fa1\u6027\u590d\u5236\u4e5f\u662f\u5982\u6b64\u3002\u65e0\u8bba\u4f60\u7684\u7c7b\u662f\u5426\u662f\u4e0d\u53ef\u53d8\u7684\uff0c\u5728\u8fd4\u56de\u5bf9\u53ef\u53d8\u5185\u90e8\u7ec4\u4ef6\u7684\u5f15\u7528\u4e4b\u524d\uff0c\u4f60\u90fd\u5e94\u8be5\u4e09\u601d\u3002\u5f88\u6709\u53ef\u80fd\uff0c\u4f60\u5e94\u8be5\u8fd4\u56de\u4e00\u4e2a\u9632\u5fa1\u6027\u526f\u672c\u3002\u8bb0\u4f4f\uff0c\u975e\u96f6\u957f\u5ea6\u6570\u7ec4\u603b\u662f\u53ef\u53d8\u7684\u3002\u56e0\u6b64\uff0c\u5728\u5c06\u5185\u90e8\u6570\u7ec4\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u4e4b\u524d\uff0c\u5e94\u8be5\u59cb\u7ec8\u521b\u5efa\u4e00\u4e2a\u9632\u5fa1\u6027\u7684\u526f\u672c\u3002\u6216\u8005\uff0c\u4f60\u53ef\u4ee5\u8fd4\u56de\u6570\u7ec4\u7684\u4e0d\u53ef\u53d8\u89c6\u56fe\u3002\u8fd9\u4e24\u79cd\u6280\u672f\u90fd\u5df2\u7ecf\u5728 ",(0,r.kt)("a",{parentName:"p",href:"./Chapter-4-Item-15-Minimize-the-accessibility-of-classes-and-members"},"Item-15")," \u4e2d\u6f14\u793a\u8fc7\u3002"),(0,r.kt)("p",null,"Arguably, the real lesson in all of this is that you should, where possible, use immutable objects as components of your objects so that you that don\u2019t have to worry about defensive copying (Item 17). In the case of our Period example, use Instant (or LocalDateTime or ZonedDateTime), unless you\u2019re using a release prior to Java 8. If you are using an earlier release, one option is to store the primitive long returned by Date.getTime() in place of a Date reference."),(0,r.kt)("p",null,"\u53ef\u4ee5\u8bf4\uff0c\u6240\u6709\u8fd9\u4e9b\u6559\u8bad\u4f53\u73b0\u4e86\uff0c\u5728\u53ef\u80fd\u7684\u60c5\u51b5\u4e0b\uff0c\u5e94\u8be5\u4f7f\u7528\u4e0d\u53ef\u53d8\u5bf9\u8c61\u4f5c\u4e3a\u5bf9\u8c61\u7684\u7ec4\u4ef6\uff0c\u8fd9\u6837\u5c31\u4e0d\u5fc5\u64cd\u5fc3\u9632\u5fa1\u6027\u590d\u5236\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-4-Item-17-Minimize-mutability"},"Item-17"),"\uff09\u3002\u5728\u6211\u4eec\u7684 Period \u793a\u4f8b\u4e2d\uff0c\u4f7f\u7528 Instant\uff08\u6216 LocalDateTime \u6216 ZonedDateTime\uff09\uff0c\u9664\u975e\u4f60\u4f7f\u7528\u7684\u662f Java 8 \u4e4b\u524d\u7684\u7248\u672c\u3002\u5982\u679c\u4f7f\u7528\u8f83\u65e9\u7684\u7248\u672c\uff0c\u4e00\u4e2a\u9009\u9879\u662f\u5b58\u50a8 ",(0,r.kt)("inlineCode",{parentName:"p"},"Date.getTime()")," \u8fd4\u56de\u7684 long \u57fa\u672c\u6570\u636e\u7c7b\u578b\uff0c\u800c\u4e0d\u662f Date \u5f15\u7528\u3002"),(0,r.kt)("p",null,"There may be a performance penalty associated with defensive copying and it isn\u2019t always justified. If a class trusts its caller not to modify an internal component, perhaps because the class and its client are both part of the same package, then it may be appropriate to dispense with defensive copying. Under these circumstances, the class documentation should make it clear that the caller must not modify the affected parameters or return values."),(0,r.kt)("p",null,"\u9632\u5fa1\u6027\u590d\u5236\u53ef\u80fd\u4f1a\u5e26\u6765\u6027\u80fd\u635f\u5931\uff0c\u800c\u4e14\u5e76\u4e0d\u603b\u662f\u5408\u7406\u7684\u3002\u5982\u679c\u4e00\u4e2a\u7c7b\u4fe1\u4efb\u5b83\u7684\u8c03\u7528\u8005\u4e0d\u4f1a\u53bb\u4fee\u6539\u5185\u90e8\u7ec4\u4ef6\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u7c7b\u548c\u5b83\u7684\u5ba2\u6237\u7aef\u90fd\u662f\u540c\u4e00\u4e2a\u5305\u7684\u4e00\u90e8\u5206\uff0c\u90a3\u4e48\u5c31\u5e94\u8be5\u907f\u514d\u9632\u5fa1\u6027\u590d\u5236\u3002\u5728\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u7c7b\u6587\u6863\u5e94\u8be5\u8868\u660e\u8c03\u7528\u8005\u4e0d\u80fd\u4fee\u6539\u53d7\u5f71\u54cd\u7684\u53c2\u6570\u6216\u8fd4\u56de\u503c\u3002"),(0,r.kt)("p",null,"Even across package boundaries, it is not always appropriate to make a defensive copy of a mutable parameter before integrating it into an object. There are some methods and constructors whose invocation indicates an explicit handoff of the object referenced by a parameter. When invoking such a method, the client promises that it will no longer modify the object directly. A method or constructor that expects to take ownership of a client-provided mutable object must make this clear in its documentation."),(0,r.kt)("p",null,"\u5373\u4f7f\u8de8\u8d8a\u5305\u8fb9\u754c\uff0c\u5728\u5c06\u53ef\u53d8\u53c2\u6570\u96c6\u6210\u5230\u5bf9\u8c61\u4e4b\u524d\u5bf9\u5176\u8fdb\u884c\u9632\u5fa1\u6027\u590d\u5236\u4e5f\u5e76\u4e0d\u603b\u662f\u5408\u9002\u7684\u3002\u6709\u4e00\u4e9b\u65b9\u6cd5\u548c\u6784\u9020\u51fd\u6570\uff0c\u5b83\u4eec\u7684\u8c03\u7528\u8981\u6c42\u53c2\u6570\u5f15\u7528\u7684\u5bf9\u8c61\u8981\u8fdb\u884c\u663e\u5f0f\u5207\u6362\u3002\u5f53\u8c03\u7528\u8fd9\u6837\u4e00\u4e2a\u65b9\u6cd5\u65f6\uff0c\u5ba2\u6237\u7aef\u627f\u8bfa\u4e0d\u518d\u76f4\u63a5\u4fee\u6539\u5bf9\u8c61\u3002\u5e0c\u671b\u62e5\u6709\u5ba2\u6237\u7aef\u63d0\u4f9b\u7684\u53ef\u53d8\u5bf9\u8c61\u6240\u6709\u6743\u7684\u65b9\u6cd5\u6216\u6784\u9020\u51fd\u6570\u5fc5\u987b\u5728\u5176\u6587\u6863\u4e2d\u660e\u786e\u8bf4\u660e\u8fd9\u4e00\u70b9\u3002"),(0,r.kt)("p",null,"Classes containing methods or constructors whose invocation indicates a transfer of control cannot defend themselves against malicious clients. Such classes are acceptable only when there is mutual trust between a class and its client or when damage to the class\u2019s invariants would harm no one but the client. An example of the latter situation is the wrapper class pattern (Item 18). Depending on the nature of the wrapper class, the client could destroy the class\u2019s invariants by directly accessing an object after it has been wrapped, but this typically would harm only the client."),(0,r.kt)("p",null,"\u5305\u542b\u65b9\u6cd5\u6216\u6784\u9020\u51fd\u6570\u7684\u7c7b\uff0c\u5982\u679c\u5176\u65b9\u6cd5\u6216\u6784\u9020\u51fd\u6570\u7684\u8c03\u7528\u9700\u8981\u79fb\u4ea4\u5bf9\u8c61\u7684\u63a7\u5236\u6743\uff0c\u5c31\u4e0d\u80fd\u4fdd\u62a4\u81ea\u5df1\u514d\u53d7\u6076\u610f\u5ba2\u6237\u7aef\u7684\u653b\u51fb\u3002\u53ea\u6709\u5f53\u4e00\u4e2a\u7c7b\u548c\u5b83\u7684\u5ba2\u6237\u7aef\u4e4b\u95f4\u76f8\u4e92\u4fe1\u4efb\uff0c\u6216\u8005\u5bf9\u7c7b\u7684\u4e0d\u53d8\u91cf\u7684\u7834\u574f\u53ea\u4f1a\u5bf9\u5ba2\u6237\u7aef\u9020\u6210\u4f24\u5bb3\u65f6\uff0c\u8fd9\u6837\u7684\u7c7b\u624d\u662f\u53ef\u63a5\u53d7\u7684\u3002\u540e\u4e00\u79cd\u60c5\u51b5\u7684\u4e00\u4e2a\u4f8b\u5b50\u662f\u5305\u88c5\u7c7b\u6a21\u5f0f\uff08",(0,r.kt)("a",{parentName:"p",href:"./Chapter-4-Item-18-Favor-composition-over-inheritance"},"Item-18"),"\uff09\u3002\u6839\u636e\u5305\u88c5\u7c7b\u7684\u6027\u8d28\uff0c\u5ba2\u6237\u7aef\u53ef\u4ee5\u5728\u5305\u88c5\u5bf9\u8c61\u4e4b\u540e\u76f4\u63a5\u8bbf\u95ee\u5bf9\u8c61\uff0c\u4ece\u800c\u7834\u574f\u7c7b\u7684\u4e0d\u53d8\u91cf\uff0c\u4f46\u8fd9\u901a\u5e38\u53ea\u4f1a\u635f\u5bb3\u5ba2\u6237\u7aef\u3002"),(0,r.kt)("p",null,"In summary, if a class has mutable components that it gets from or returns to its clients, the class must defensively copy these components. If the cost of the copy would be prohibitive and the class trusts its clients not to modify the components inappropriately, then the defensive copy may be replaced by documentation outlining the client\u2019s responsibility not to modify the affected components."),(0,r.kt)("p",null,"\u603b\u800c\u8a00\u4e4b\uff0c\u5982\u679c\u4e00\u4e2a\u7c7b\u5177\u6709\u4ece\u5ba2\u6237\u7aef\u83b7\u53d6\u6216\u8fd4\u56de\u7ed9\u5ba2\u6237\u7aef\u7684\u53ef\u53d8\u7ec4\u4ef6\uff0c\u5219\u8be5\u7c7b\u5fc5\u987b\u9632\u5fa1\u6027\u5730\u590d\u5236\u8fd9\u4e9b\u7ec4\u4ef6\u3002\u5982\u679c\u590d\u5236\u7684\u6210\u672c\u8fc7\u9ad8\uff0c\u5e76\u4e14\u7c7b\u4fe1\u4efb\u5b83\u7684\u5ba2\u6237\u7aef\u4e0d\u4f1a\u4e0d\u9002\u5f53\u5730\u4fee\u6539\u7ec4\u4ef6\uff0c\u90a3\u4e48\u53ef\u4ee5\u4e0d\u8fdb\u884c\u9632\u5fa1\u6027\u7684\u590d\u5236\uff0c\u53d6\u800c\u4ee3\u4e4b\u7684\u662f\u5728\u6587\u6863\u4e2d\u6307\u660e\u5ba2\u6237\u7aef\u7684\u804c\u8d23\u662f\u4e0d\u5f97\u4fee\u6539\u53d7\u5230\u5f71\u54cd\u7684\u7ec4\u4ef6\u3002"),(0,r.kt)("hr",null),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},(0,r.kt)("a",{parentName:"strong",href:"./Chapter-8-Introduction"},"Back to contents of the chapter\uff08\u8fd4\u56de\u7ae0\u8282\u76ee\u5f55\uff09"))),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Previous Item\uff08\u4e0a\u4e00\u6761\u76ee\uff09\uff1a",(0,r.kt)("a",{parentName:"strong",href:"./Chapter-8-Item-49-Check-parameters-for-validity"},"Item 49: Check parameters for validity\uff08\u68c0\u67e5\u53c2\u6570\u7684\u6709\u6548\u6027\uff09"))),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Next Item\uff08\u4e0b\u4e00\u6761\u76ee\uff09\uff1a",(0,r.kt)("a",{parentName:"strong",href:"./Chapter-8-Item-51-Design-method-signatures-carefully"},"Item 51: Design method signatures carefully\uff08\u4ed4\u7ec6\u8bbe\u8ba1\u65b9\u6cd5\u7b7e\u540d\uff09")))))}h.isMDXComponent=!0}}]);